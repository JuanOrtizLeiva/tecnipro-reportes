{% extends "cobranzas/base.html" %}
{% block title %}Dashboard{% endblock %}
{% block breadcrumb %}<span class="sep">/</span><span class="current">Dashboard</span>{% endblock %}

{% block extra_styles %}
<style>
.stat-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
.kpi-card .kpi-icon.blue   { background: #ebf4ff; }
.kpi-card .kpi-icon.green  { background: #f0fff4; }
.kpi-card .kpi-icon.amber  { background: #fffbeb; }
.kpi-card .kpi-icon.red    { background: #fff5f5; }
.kpi-card .kpi-icon.purple { background: #faf5ff; }
.kpi-card .kpi-icon i[data-lucide] { width: 18px; height: 18px; }
.chart-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 24px; }
.chart-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 24px; }
.chart-container { position: relative; height: 260px; }
.otic-table tbody td:first-child { font-weight: 500; max-width: 260px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.alerta-section { margin-bottom: 16px; }
.alerta-header { display: flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: var(--radius-sm) var(--radius-sm) 0 0; font-size: 13px; font-weight: 700; }
.alerta-90 .alerta-header { background: #fff5f5; color: var(--c-pendiente); }
.alerta-60 .alerta-header { background: #fffbeb; color: #b7791f; }
.alerta-30 .alerta-header { background: #fffff0; color: #d69e2e; }
.alerta-header i[data-lucide] { width: 14px; height: 14px; }
.year-bar { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-bottom: 16px; }
.year-chip { padding: 4px 12px; border-radius: 100px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary); }
.year-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <div class="page-title">Dashboard de Cobranzas</div>
    <div class="page-subtitle">Resumen ejecutivo de ventas y cobranza activa</div>
  </div>
  <div id="last-update" style="font-size:12px;color:var(--text-secondary);margin-top:6px"></div>
</div>

<div id="dash-loading" class="loading-state"><div class="spinner"></div><p style="margin-top:12px">Cargando datos...</p></div>
<div id="dash-content" style="display:none">

<!-- ═══ Tabs ═══ -->
<div class="tabs" data-tabs>
  <button class="tab-btn active" data-tab="tab-historico"><i data-lucide="bar-chart-2"></i> Ventas Históricas</button>
  <button class="tab-btn" data-tab="tab-cobranza"><i data-lucide="credit-card"></i> Cobranzas Activas ({{ anio_corte }}+)</button>
  <button class="tab-btn" data-tab="tab-clientes"><i data-lucide="users"></i> Clientes &amp; Cursos</button>
</div>

<!-- ══ TAB A: Ventas Históricas ══ -->
<div id="tab-historico" class="tab-panel active">
  <!-- KPIs históricos -->
  <div class="kpi-grid" id="kpi-historico"></div>

  <!-- Gráfico anual + donut OTICs -->
  <div class="chart-grid">
    <div class="card">
      <div class="card-header">
        <div class="card-title"><i data-lucide="bar-chart-2"></i> Facturación Anual (neta de NC)</div>
      </div>
      <div class="card-body"><div class="chart-container"><canvas id="chart-anual"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title"><i data-lucide="pie-chart"></i> Por OTIC</div>
      </div>
      <div class="card-body"><div class="chart-container"><canvas id="chart-otic-donut"></canvas></div></div>
    </div>
  </div>

  <!-- Tendencia mensual -->
  <div class="card" style="margin-bottom:24px">
    <div class="card-header">
      <div class="card-title"><i data-lucide="trending-up"></i> Tendencia Mensual de Ventas</div>
    </div>
    <div class="card-body"><div class="chart-container" style="height:200px"><canvas id="chart-mensual"></canvas></div></div>
  </div>

  <!-- Tabla por OTIC -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><i data-lucide="building-2"></i> Facturación por OTIC</div>
      <div id="otic-year-filter" class="year-bar"></div>
    </div>
    <div class="card-body" style="padding:0">
      <div class="table-wrap" style="border:none;border-radius:0">
        <table class="otic-table">
          <thead><tr>
            <th>OTIC / Receptor</th><th class="num">Facturas</th>
            <th class="num">Bruto</th><th class="num">NC</th><th class="num">Neto</th>
          </tr></thead>
          <tbody id="otic-tbody"><tr><td colspan="5" class="table-empty">Cargando...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ══ TAB B: Cobranzas Activas ══ -->
<div id="tab-cobranza" class="tab-panel">
  <div class="kpi-grid" id="kpi-cobranza"></div>

  <div class="chart-grid">
    <div class="card">
      <div class="card-header"><div class="card-title"><i data-lucide="bar-chart-3"></i> Facturado vs Cobrado por Mes</div></div>
      <div class="card-body"><div class="chart-container"><canvas id="chart-cobranza-mensual"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title"><i data-lucide="pie-chart"></i> Distribución de Estados</div></div>
      <div class="card-body"><div class="chart-container"><canvas id="chart-estados"></canvas></div></div>
    </div>
  </div>

  <!-- Top OTICs pendientes -->
  <div class="card" style="margin-bottom:24px">
    <div class="card-header"><div class="card-title"><i data-lucide="alert-triangle"></i> Top OTICs con Mayor Saldo Pendiente</div></div>
    <div class="card-body" style="padding:0">
      <div class="table-wrap" style="border:none;border-radius:0">
        <table><thead><tr><th>OTIC</th><th class="num">Facturas</th><th class="num">Saldo Pendiente</th></tr></thead>
        <tbody id="top-otics-tbody"></tbody></table>
      </div>
    </div>
  </div>

  <!-- Alertas de vencimiento -->
  <div class="card">
    <div class="card-header"><div class="card-title"><i data-lucide="clock"></i> Alertas de Vencimiento</div></div>
    <div class="card-body" id="alertas-container" style="padding:12px"></div>
  </div>
</div>

<!-- ══ TAB C: Clientes & Cursos ══ -->
<div id="tab-clientes" class="tab-panel">
  <div class="chart-grid">
    <div class="card">
      <div class="card-header"><div class="card-title"><i data-lucide="users"></i> Top Clientes por Facturación ({{ anio_corte }}+)</div></div>
      <div class="card-body"><div class="chart-container"><canvas id="chart-top-clientes"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title"><i data-lucide="book-open"></i> Top Cursos por Facturación ({{ anio_corte }}+)</div></div>
      <div class="card-body"><div class="chart-container"><canvas id="chart-top-cursos"></canvas></div></div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><div class="card-title"><i data-lucide="users"></i> Detalle Clientes {{ anio_corte }}+</div></div>
    <div class="card-body" style="padding:0">
      <div class="table-wrap" style="border:none;border-radius:0">
        <table><thead><tr>
          <th>Cliente</th><th class="num">Facturas</th>
          <th class="num">Facturado</th><th class="num">Cobrado</th>
          <th class="num">Pendiente</th><th class="num">% Cobro</th>
        </tr></thead>
        <tbody id="clientes-tbody"></tbody></table>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="card-header"><div class="card-title"><i data-lucide="book-open"></i> Detalle Cursos {{ anio_corte }}+</div></div>
    <div class="card-body" style="padding:0">
      <div class="table-wrap" style="border:none;border-radius:0">
        <table><thead><tr>
          <th>Curso</th><th class="num">Facturas</th><th class="num">Clientes</th><th class="num">Facturado</th>
        </tr></thead>
        <tbody id="cursos-tbody"></tbody></table>
      </div>
    </div>
  </div>
</div>

</div><!-- #dash-content -->
{% endblock %}

{% block scripts %}
<script>
const PRIMARY = '#1a365d', PRIMARY_L = '#2c5282';
const PALETA  = ['#1a365d','#2b6cb0','#3182ce','#63b3ed','#bee3f8','#ebf8ff'];
const ESTADOS = { Pendiente:'#e53e3e', Parcial:'#d69e2e', Pagada:'#38a169', Anulada:'#a0aec0' };

let dashData = null;
let oticAnio = null;

/* ── Chart helpers ── */
Chart.defaults.font.family = 'DM Sans, sans-serif';
Chart.defaults.color = '#718096';
Chart.defaults.plugins.legend.display = false;

function mkBar(id, labels, datasets, opts = {}) {
  const ctx = document.getElementById(id);
  if (!ctx) return;
  return new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: datasets.length > 1, position: 'bottom', labels: { font: { size: 12 }, padding: 16, boxWidth: 12 } }, tooltip: { callbacks: { label: c => ' ' + fmt(c.raw) } } },
      scales: { y: { ticks: { callback: v => fmtCompact(v) }, grid: { color: '#f0f4f8' } }, x: { grid: { display: false } } },
      ...opts
    }
  });
}

function mkLine(id, labels, datasets) {
  const ctx = document.getElementById(id);
  if (!ctx) return;
  return new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ' ' + fmt(c.raw) } } },
      scales: { y: { ticks: { callback: v => fmtCompact(v) }, grid: { color: '#f0f4f8' } }, x: { grid: { display: false } } },
      elements: { line: { tension: .3 }, point: { radius: 3 } }
    }
  });
}

function mkDonut(id, labels, values, colors) {
  const ctx = document.getElementById(id);
  if (!ctx) return;
  return new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: true, position: 'right', labels: { font: { size: 11 }, padding: 12, boxWidth: 10 } }, tooltip: { callbacks: { label: c => ` ${c.label}: ${fmt(c.raw)}` } } },
      cutout: '65%'
    }
  });
}

function fmtCompact(v) {
  if (Math.abs(v) >= 1e9) return '$' + (v/1e9).toFixed(1) + 'B';
  if (Math.abs(v) >= 1e6) return '$' + (v/1e6).toFixed(1) + 'M';
  if (Math.abs(v) >= 1e3) return '$' + (v/1e3).toFixed(0) + 'K';
  return '$' + v;
}

/* ── Render histórico ── */
function renderHistorico(d) {
  const hist = d.historico;
  // KPIs
  const aniosDisp = hist.anios_disponibles || [];
  const totalNeto = hist.por_anio.reduce((s,a) => s + a.monto_neto, 0);
  const totalNC   = hist.total_nc_historico;
  const promedio  = aniosDisp.length ? Math.round(totalNeto / aniosDisp.length) : 0;
  const mejorAnio = hist.por_anio.reduce((m,a) => a.monto_neto > (m?.monto_neto||0) ? a : m, null);

  document.getElementById('kpi-historico').innerHTML = `
    ${kpiCard('Facturación Histórica Neta', fmt(totalNeto), 'blue', 'trending-up', `${aniosDisp.length} años`)}
    ${kpiCard('Promedio Anual', fmt(promedio), 'purple', 'calendar', 'Neto de NC')}
    ${kpiCard('Mejor Año', mejorAnio ? `${mejorAnio.anio}` : '—', 'green', 'award', mejorAnio ? fmt(mejorAnio.monto_neto) : '')}
    ${kpiCard('Total NC Históricas', fmt(totalNC), 'red', 'minus-circle', `${hist.por_anio.reduce((s,a)=>s+a.num_nc,0)} documentos`)}
  `;

  // Chart anual
  mkBar('chart-anual',
    hist.por_anio.map(a => a.anio),
    [{ label: 'Neto', data: hist.por_anio.map(a => a.monto_neto), backgroundColor: PALETA, borderRadius: 4 }]
  );

  // Chart mensual
  const meses12 = hist.por_mes.slice(-24);
  mkLine('chart-mensual', meses12.map(m => m.periodo),
    [{ label: 'Facturado', data: meses12.map(m => m.monto_bruto), borderColor: PRIMARY, backgroundColor: 'rgba(26,54,93,.06)', fill: true }]
  );

  // Donut OTICs
  const top5 = (d.por_otic_historico || []).slice(0, 5);
  mkDonut('chart-otic-donut', top5.map(o => truncate(o.razon_social, 28)), top5.map(o => o.monto_neto), PALETA);

  // Tabla OTICs + filtros por año
  renderOticFilter(hist.anios_disponibles);
  renderOticTabla(d.por_otic_historico);
}

function renderOticFilter(anios) {
  const c = document.getElementById('otic-year-filter');
  c.innerHTML = `<span class="year-chip active" data-y="null">Todos</span>` +
    anios.map(a => `<span class="year-chip" data-y="${a}">${a}</span>`).join('');
  c.querySelectorAll('.year-chip').forEach(chip => {
    chip.addEventListener('click', async () => {
      c.querySelectorAll('.year-chip').forEach(ch => ch.classList.remove('active'));
      chip.classList.add('active');
      const anio = chip.dataset.y === 'null' ? null : parseInt(chip.dataset.y);
      const url  = anio ? `/api/cobranzas/stats/historico?anio=${anio}` : '/api/cobranzas/stats/historico';
      const resp = await apiFetch(url);
      const d2   = await resp.json();
      renderOticTabla(d2.por_otic || []);
    });
  });
}

function renderOticTabla(otics) {
  const tbody = document.getElementById('otic-tbody');
  if (!otics || !otics.length) { tbody.innerHTML = '<tr><td colspan="5" class="table-empty">Sin datos</td></tr>'; return; }
  tbody.innerHTML = otics.map(o => `<tr>
    <td title="${o.razon_social}">${truncate(o.razon_social, 40)}</td>
    <td class="num">${fmtNum(o.num_facturas)}</td>
    <td class="num">${fmt(o.monto_bruto)}</td>
    <td class="num" style="color:var(--c-negativo)">${fmt(o.monto_nc)}</td>
    <td class="num" style="font-weight:700">${fmt(o.monto_neto)}</td>
  </tr>`).join('');
}

/* ── Render cobranza activa ── */
function renderCobranza(d) {
  const k = d.kpis;
  document.getElementById('kpi-cobranza').innerHTML = `
    ${kpiCard('Total Facturado', fmt(k.total_facturado), 'blue', 'file-text', `${k.num_facturas} facturas`)}
    ${kpiCard('Total Cobrado',   fmt(k.total_cobrado),   'green', 'check-circle', `${k.pct_recuperacion}% recuperado`)}
    ${kpiCard('Total Pendiente', fmt(k.total_pendiente), 'red',   'clock', `${k.num_pendientes} pendientes, ${k.num_parciales} parciales`)}
    ${kpiCard('Días Prom. Cobro', k.dias_promedio_cobro > 0 ? `${k.dias_promedio_cobro}d` : '—', 'amber', 'calendar-clock', 'Facturas ya pagadas')}
    ${kpiCard('NC Aplicadas', fmt(k.monto_nc_aplicado), 'purple', 'minus-circle', 'Notas de crédito')}
    ${kpiCard('% Recuperación', k.pct_recuperacion + '%', 'green', 'trending-up', 'Sobre facturado')}
  `;

  // Chart cobranza mensual
  const cm = d.cobranza_mensual || [];
  mkBar('chart-cobranza-mensual', cm.map(m => m.periodo), [
    { label: 'Facturado', data: cm.map(m => m.facturado), backgroundColor: 'rgba(26,54,93,.7)', borderRadius: 4 },
    { label: 'Cobrado',   data: cm.map(m => m.cobrado),   backgroundColor: '#38a169', borderRadius: 4 },
  ], { plugins: { legend: { display: true } } });

  // Donut estados
  const est = d.estados || [];
  const eColors = est.map(e => ESTADOS[e.estado] || '#a0aec0');
  mkDonut('chart-estados', est.map(e => e.estado), est.map(e => e.monto), eColors);

  // Top OTICs pendientes
  const tbody = document.getElementById('top-otics-tbody');
  tbody.innerHTML = (d.top_otics || []).map(o => `<tr>
    <td>${truncate(o.razon_social, 45)}</td>
    <td class="num">${fmtNum(o.num_facturas_pendientes)}</td>
    <td class="num" style="font-weight:700;color:var(--c-pendiente)">${fmt(o.saldo_total_pendiente)}</td>
  </tr>`).join('') || '<tr><td colspan="3" class="table-empty">Sin facturas pendientes</td></tr>';

  // Alertas
  renderAlertas(d.alertas);
}

function renderAlertas(alertas) {
  if (!alertas) return;
  const c = document.getElementById('alertas-container');
  const secs = [
    { key: 'mas_de_90_dias', label: '> 90 días', cls: 'alerta-90', icon: 'alert-octagon' },
    { key: 'entre_60_90',    label: '60 – 90 días', cls: 'alerta-60', icon: 'alert-triangle' },
    { key: 'entre_30_60',    label: '30 – 60 días', cls: 'alerta-30', icon: 'clock' },
  ];
  let html = '';
  for (const s of secs) {
    const items = alertas[s.key] || [];
    if (!items.length) continue;
    html += `<div class="alerta-section ${s.cls}">
      <div class="alerta-header"><i data-lucide="${s.icon}"></i> ${s.label} sin cobro completo (${items.length} facturas)</div>
      <div class="table-wrap" style="border-radius:0 0 var(--radius) var(--radius)">
        <table><thead><tr><th>Folio</th><th>OTIC</th><th>Días</th><th class="num">Saldo Pendiente</th><th>Estado</th></tr></thead>
        <tbody>${items.map(f => `<tr>
          <td class="mono">${f.folio}</td>
          <td>${truncate(f.razon_social, 40)}</td>
          <td class="num" style="font-weight:700">${f.dias}</td>
          <td class="num">${fmt(f.saldo_pendiente)}</td>
          <td>${badgeEstado(f.estado)}</td>
        </tr>`).join('')}</tbody></table>
      </div>
    </div>`;
  }
  c.innerHTML = html || '<p style="color:var(--text-secondary);text-align:center;padding:16px">Sin alertas de vencimiento</p>';
  lucide.createIcons({ nodes: [c] });
}

/* ── Render Clientes & Cursos ── */
function renderClientesCursos(d) {
  const tc = d.top_clientes || [];
  const tcu = d.top_cursos || [];

  // Chart top clientes
  mkBar('chart-top-clientes', tc.map(c => truncate(c.nombre, 20)),
    [{ label: 'Facturado', data: tc.map(c => c.total_facturado), backgroundColor: PRIMARY, borderRadius: 4 }]
  );

  // Chart top cursos
  mkBar('chart-top-cursos', tcu.map(c => truncate(c.curso, 20)),
    [{ label: 'Facturado', data: tcu.map(c => c.total_facturado), backgroundColor: PRIMARY_L, borderRadius: 4 }]
  );

  // Tabla clientes
  document.getElementById('clientes-tbody').innerHTML = tc.map(c => `<tr>
    <td><a href="/cobranzas/clientes" style="color:var(--primary);font-weight:600">${c.nombre}</a></td>
    <td class="num">${c.num_facturas}</td>
    <td class="num">${fmt(c.total_facturado)}</td>
    <td class="num" style="color:var(--c-pagada)">${fmt(c.total_cobrado)}</td>
    <td class="num" style="color:var(--c-pendiente)">${fmt(c.total_pendiente)}</td>
    <td class="num">${c.pct_cobrado}%</td>
  </tr>`).join('') || '<tr><td colspan="6" class="table-empty">Sin clientes asignados. <a href="/cobranzas/facturas">Ir a Facturas</a></td></tr>';

  // Tabla cursos
  document.getElementById('cursos-tbody').innerHTML = tcu.map(c => `<tr>
    <td style="font-weight:500">${c.curso}</td>
    <td class="num">${c.num_facturas}</td>
    <td class="num">${c.num_clientes_distintos}</td>
    <td class="num">${fmt(c.total_facturado)}</td>
  </tr>`).join('') || '<tr><td colspan="4" class="table-empty">Sin cursos asignados</td></tr>';
}

/* ── KPI card helper ── */
function kpiCard(label, value, color, icon, sub = '') {
  return `<div class="kpi-card">
    <div class="kpi-icon ${color}"><i data-lucide="${icon}" style="color:var(--c-${color}-icon,var(--primary))"></i></div>
    <div class="kpi-label">${label}</div>
    <div class="kpi-value">${value}</div>
    ${sub ? `<div class="kpi-sub">${sub}</div>` : ''}
  </div>`;
}

function truncate(s, n) { return s && s.length > n ? s.substring(0, n) + '…' : (s || '—'); }

/* ── Load dashboard ── */
async function loadDashboard() {
  try {
    const resp = await apiFetch('/api/cobranzas/stats/dashboard');
    dashData = await resp.json();
    document.getElementById('dash-loading').style.display = 'none';
    document.getElementById('dash-content').style.display  = 'block';
    document.getElementById('last-update').textContent = 'Actualizado: ' + new Date().toLocaleTimeString('es-CL');
    renderHistorico(dashData);
    renderCobranza(dashData);
    renderClientesCursos(dashData);
    lucide.createIcons();
  } catch(e) {
    document.getElementById('dash-loading').innerHTML = `<div class="alert alert-error"><i data-lucide="x-circle"></i> Error cargando datos: ${e.message}</div>`;
    lucide.createIcons({ nodes: [document.getElementById('dash-loading')] });
  }
}

// Override tab switch to initialize charts lazily
function onTabChange(tab) { lucide.createIcons(); }

loadDashboard();
</script>
{% endblock %}
