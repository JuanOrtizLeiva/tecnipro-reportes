{% extends "cobranzas/base.html" %}

{% block title %}Estadísticas — Cobranzas{% endblock %}

{% block breadcrumb %}
<span>Cobranzas</span>
<i data-lucide="chevron-right" style="width:14px;height:14px;color:var(--text-muted)"></i>
<span>Estadísticas</span>
{% endblock %}

{% block extra_styles %}
<style>
/* ── Tabs principales ──────────────────────────────────── */
.section-tabs {
  display: flex;
  gap: 4px;
  background: var(--bg);
  border-radius: 10px;
  padding: 4px;
  margin-bottom: 28px;
  border: 1px solid var(--border);
  width: fit-content;
}
.section-tab {
  padding: 8px 20px;
  border-radius: 7px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-muted);
  cursor: pointer;
  transition: all .15s;
  border: none;
  background: none;
  display: flex;
  align-items: center;
  gap: 6px;
}
.section-tab.active {
  background: var(--white);
  color: var(--primary);
  font-weight: 600;
  box-shadow: 0 1px 3px rgba(0,0,0,.08);
}
.tab-content { display: none; }
.tab-content.active { display: block; }

/* ── Grids de gráficos ─────────────────────────────────── */
.charts-grid-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}
.charts-grid-3 {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}
.chart-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 0;
}
.chart-card.mb { margin-bottom: 20px; }
.chart-card h3 {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: .5px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

/* ── KPIs ──────────────────────────────────────────────── */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}
.kpi-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px 20px;
}
.kpi-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: .5px;
  color: var(--text-muted);
  margin-bottom: 6px;
}
.kpi-value {
  font-size: 22px;
  font-weight: 700;
  color: var(--text);
  font-family: var(--font-mono);
  letter-spacing: -1px;
  line-height: 1;
  margin-bottom: 4px;
}
.kpi-sub { font-size: 11px; color: var(--text-muted); }
.kpi-value.verde { color: var(--estado-pagada); }
.kpi-value.ambar { color: var(--estado-parcial); }
.kpi-value.rojo  { color: var(--estado-vencida); }
.kpi-value.num-lg { font-size: 26px; }

/* ── Tablas de estadísticas ─────────────────────────────── */
.stats-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.stats-table th {
  text-align: left;
  padding: 8px 12px;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: .4px;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
.stats-table th.r { text-align: right; }
.stats-table td {
  padding: 9px 12px;
  border-bottom: 1px solid var(--border-light);
  color: var(--text);
}
.stats-table td.r {
  text-align: right;
  font-family: var(--font-mono);
  font-size: 12px;
}
.stats-table tr:last-child td { border-bottom: none; }
.stats-table tbody tr:hover { background: var(--bg); }

/* ── Barra inline ─────────────────────────────────────── */
.mini-bar-wrap { display: flex; align-items: center; gap: 8px; }
.mini-bar {
  flex: 1;
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
  min-width: 48px;
}
.mini-bar-fill { height: 100%; border-radius: 3px; background: var(--primary); }
.mini-pct {
  font-size: 11px;
  color: var(--text-muted);
  width: 34px;
  text-align: right;
  flex-shrink: 0;
  font-family: var(--font-mono);
}

/* ── Alertas de antigüedad ──────────────────────────────── */
.alertas-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}
.alerta-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-left: 4px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
}
.alerta-card.critica { border-left-color: var(--estado-vencida); }
.alerta-card.alta    { border-left-color: var(--estado-parcial); }
.alerta-card.media   { border-left-color: #f59e0b; }
.alerta-card.baja    { border-left-color: var(--estado-pagada); }
.alerta-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: .4px;
  margin-bottom: 8px;
}
.alerta-count {
  font-size: 28px;
  font-weight: 800;
  font-family: var(--font-mono);
  color: var(--text);
  line-height: 1;
  margin-bottom: 4px;
}
.alerta-monto { font-size: 12px; color: var(--text-muted); font-family: var(--font-mono); }

/* ── Selector de año ─────────────────────────────────────── */
.year-sel {
  display: flex;
  align-items: center;
  gap: 6px;
}
.year-sel label { font-size: 11px; color: var(--text-muted); font-weight: normal; text-transform: none; letter-spacing: 0; }
.year-sel select {
  padding: 3px 8px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 12px;
  background: var(--white);
  color: var(--text);
}

/* ── Placeholder cargando ──────────────────────────────── */
.ph {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  color: var(--text-muted);
  font-size: 13px;
}
.spin-sm {
  width: 16px;
  height: 16px;
  border: 2px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin .7s linear infinite;
  flex-shrink: 0;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<!-- ── Tabs principales ──────────────────────────────────── -->
<div class="section-tabs" role="tablist">
  <button class="section-tab active" onclick="cambiarTab('historico', this)" role="tab">
    <i data-lucide="archive" style="width:15px;height:15px"></i>
    Histórico (todos los años)
  </button>
  <button class="section-tab" onclick="cambiarTab('activo', this)" role="tab">
    <i data-lucide="trending-up" style="width:15px;height:15px"></i>
    Gestión activa (2026+)
  </button>
</div>

<!-- ══════════════════════════════════════════════════════
     TAB: HISTÓRICO
════════════════════════════════════════════════════════ -->
<div id="tab-historico" class="tab-content active">

  <!-- KPIs generales -->
  <div id="kpi-historico" class="kpi-row">
    <div class="kpi-card" style="min-height:90px"><div class="ph" style="height:60px"><div class="spin-sm"></div></div></div>
    <div class="kpi-card" style="min-height:90px"><div class="ph" style="height:60px"><div class="spin-sm"></div></div></div>
    <div class="kpi-card" style="min-height:90px"><div class="ph" style="height:60px"><div class="spin-sm"></div></div></div>
    <div class="kpi-card" style="min-height:90px"><div class="ph" style="height:60px"><div class="spin-sm"></div></div></div>
  </div>

  <!-- Tendencia mensual + Comparativo anual -->
  <div class="charts-grid-2" style="margin-bottom:20px">
    <div class="chart-card">
      <h3>Tendencia Mensual de Facturación</h3>
      <canvas id="chTendencia" height="220"></canvas>
    </div>
    <div class="chart-card">
      <h3>Facturación Anual Comparativa</h3>
      <canvas id="chAnual" height="220"></canvas>
    </div>
  </div>

  <!-- Facturación por OTIC + donut -->
  <div class="charts-grid-2" style="margin-bottom:20px">
    <div class="chart-card">
      <h3>
        Facturación por OTIC
        <span class="year-sel">
          <label for="selectAnioOtic">Filtrar:</label>
          <select id="selectAnioOtic" onchange="cambiarAnioOtic(this.value)">
            <option value="">Todos los años</option>
          </select>
        </span>
      </h3>
      <div id="tablaOticWrap">
        <div class="ph" style="height:120px"><div class="spin-sm"></div> Cargando...</div>
      </div>
    </div>
    <div class="chart-card">
      <h3>Distribución por OTIC (top 8)</h3>
      <canvas id="chOticDonut" height="260"></canvas>
    </div>
  </div>

</div><!-- /tab-historico -->


<!-- ══════════════════════════════════════════════════════
     TAB: GESTIÓN ACTIVA
════════════════════════════════════════════════════════ -->
<div id="tab-activo" class="tab-content">

  <!-- KPIs de cobranza 2026+ -->
  <div id="kpi-activo" class="kpi-row">
    <div class="kpi-card" style="min-height:90px"><div class="ph" style="height:60px"><div class="spin-sm"></div></div></div>
    <div class="kpi-card" style="min-height:90px"><div class="ph" style="height:60px"><div class="spin-sm"></div></div></div>
    <div class="kpi-card" style="min-height:90px"><div class="ph" style="height:60px"><div class="spin-sm"></div></div></div>
    <div class="kpi-card" style="min-height:90px"><div class="ph" style="height:60px"><div class="spin-sm"></div></div></div>
  </div>

  <!-- Alertas de antigüedad -->
  <div style="margin-bottom:8px;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px">
    Antigüedad de la cartera pendiente
  </div>
  <div id="alertasGrid" class="alertas-grid">
    <div class="alerta-card"><div class="ph" style="height:56px"><div class="spin-sm"></div></div></div>
    <div class="alerta-card"><div class="ph" style="height:56px"><div class="spin-sm"></div></div></div>
    <div class="alerta-card"><div class="ph" style="height:56px"><div class="spin-sm"></div></div></div>
    <div class="alerta-card"><div class="ph" style="height:56px"><div class="spin-sm"></div></div></div>
  </div>

  <!-- Facturado vs Cobrado + Estados -->
  <div class="charts-grid-2" style="margin-bottom:20px">
    <div class="chart-card">
      <h3>Facturado vs Cobrado por Mes</h3>
      <canvas id="chFacCob" height="220"></canvas>
    </div>
    <div class="chart-card">
      <h3>Estado de la Cartera (por monto)</h3>
      <canvas id="chEstados" height="220"></canvas>
    </div>
  </div>

  <!-- Top Clientes + Top Cursos (horizontal bars) -->
  <div class="charts-grid-2" style="margin-bottom:20px">
    <div class="chart-card">
      <h3>Top 10 Clientes por Monto Facturado</h3>
      <canvas id="chClientes" height="280"></canvas>
    </div>
    <div class="chart-card">
      <h3>Top 10 Cursos por Monto Facturado</h3>
      <canvas id="chCursos" height="280"></canvas>
    </div>
  </div>

  <!-- Tabla clientes detalle -->
  <div class="chart-card mb">
    <h3>Detalle de Clientes (2026+)</h3>
    <div style="overflow-x:auto">
      <table class="stats-table">
        <thead>
          <tr>
            <th style="width:30px">#</th>
            <th>Cliente</th>
            <th class="r">Facturas</th>
            <th class="r">Facturado</th>
            <th class="r">Cobrado</th>
            <th class="r">Pendiente</th>
            <th style="min-width:120px">Recuperación</th>
          </tr>
        </thead>
        <tbody id="tbClientes">
          <tr><td colspan="7" style="text-align:center;padding:28px">
            <div class="ph"><div class="spin-sm"></div></div>
          </td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Tabla cursos detalle -->
  <div class="chart-card mb">
    <h3>Detalle de Cursos (2026+)</h3>
    <div style="overflow-x:auto">
      <table class="stats-table">
        <thead>
          <tr>
            <th style="width:30px">#</th>
            <th>Curso</th>
            <th class="r">Facturas</th>
            <th class="r">Clientes</th>
            <th class="r">Facturado</th>
          </tr>
        </thead>
        <tbody id="tbCursos">
          <tr><td colspan="5" style="text-align:center;padding:28px">
            <div class="ph"><div class="spin-sm"></div></div>
          </td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- OTICs con mayor pendiente -->
  <div class="chart-card mb">
    <h3>OTICs con Mayor Saldo Pendiente (2026+)</h3>
    <div style="overflow-x:auto">
      <table class="stats-table">
        <thead>
          <tr>
            <th style="width:30px">#</th>
            <th>OTIC</th>
            <th class="r">Facturas pendientes</th>
            <th class="r">Saldo pendiente</th>
            <th style="min-width:120px">Participación</th>
          </tr>
        </thead>
        <tbody id="tbOticPend">
          <tr><td colspan="5" style="text-align:center;padding:28px">
            <div class="ph"><div class="spin-sm"></div></div>
          </td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div><!-- /tab-activo -->
{% endblock %}

{% block scripts %}
<script>
/* ══════════════════════════════════════════════════════
   Estado global
══════════════════════════════════════════════════════ */
let datos = null;
let charts = {};
let oticCache = {};   // { anio|"": [{razon_social, monto_bruto, ...}] }

/* ── Paleta ─────────────────────────────────────────── */
const C = {
  primary: '#1a365d',
  blue2:   '#2b6cb0',
  green:   '#276749',
  amber:   '#b7791f',
  red:     '#9b2c2c',
  gray:    '#718096',
  blues: ['#1a365d','#2a4a7f','#2b6cb0','#3182ce','#4299e1','#63b3ed','#90cdf4','#bee3f8'],
};

/* ── Helpers Chart.js ───────────────────────────────── */
const fmtM = v => '$' + (v/1e6).toFixed(1) + 'M';

function mkBar(id, labels, datasets, stacked) {
  const ctx = document.getElementById(id); if (!ctx) return;
  if (charts[id]) charts[id].destroy();
  charts[id] = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      plugins: {
        legend: { display: datasets.length > 1, position: 'top',
          labels: { font: { size: 11 }, padding: 10 } },
        tooltip: { callbacks: { label: c => ' ' + fmt(c.raw||0) } },
      },
      scales: {
        y: { stacked: !!stacked,
             ticks: { callback: fmtM, font: { size: 10 } },
             grid: { color: '#f0f0f0' } },
        x: { stacked: !!stacked,
             ticks: { font: { size: 10 }, maxRotation: 45 },
             grid: { display: false } },
      },
    },
  });
}

function mkBarH(id, labels, data, color) {
  const ctx = document.getElementById(id); if (!ctx) return;
  if (charts[id]) charts[id].destroy();
  charts[id] = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ data, backgroundColor: color||C.primary, borderRadius: 3 }] },
    options: {
      indexAxis: 'y', responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: c => ' ' + fmt(c.raw||0) } },
      },
      scales: {
        x: { ticks: { callback: fmtM, font: { size: 10 } }, grid: { color: '#f0f0f0' } },
        y: { ticks: { font: { size: 11 } }, grid: { display: false } },
      },
    },
  });
}

function mkLine(id, labels, datasets) {
  const ctx = document.getElementById(id); if (!ctx) return;
  if (charts[id]) charts[id].destroy();
  charts[id] = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      plugins: {
        legend: { display: datasets.length > 1, position: 'top',
          labels: { font: { size: 11 }, padding: 10 } },
        tooltip: { callbacks: { label: c => ' ' + fmt(c.raw||0) } },
      },
      scales: {
        y: { ticks: { callback: fmtM, font: { size: 10 } }, grid: { color: '#f0f0f0' } },
        x: { ticks: { font: { size: 10 }, maxRotation: 45 }, grid: { display: false } },
      },
    },
  });
}

function mkDonut(id, labels, data, colors) {
  const ctx = document.getElementById(id); if (!ctx) return;
  if (charts[id]) charts[id].destroy();
  charts[id] = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{
      data,
      backgroundColor: colors || C.blues.slice(0, labels.length),
      borderWidth: 2, borderColor: '#fff',
    }]},
    options: {
      responsive: true, cutout: '55%',
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 8 } },
        tooltip: { callbacks: { label: c => ' ' + fmt(c.raw||0) } },
      },
    },
  });
}

/* ── Helpers de label de mes ────────────────────────── */
const MESES = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
function labelMes(periodo) {
  // periodo = "2026-01"
  const [a, m] = periodo.split('-');
  return MESES[parseInt(m)-1] + ' ' + a.slice(2);
}

/* ══════════════════════════════════════════════════════
   Tabs
══════════════════════════════════════════════════════ */
function cambiarTab(tab, btn) {
  document.querySelectorAll('.section-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
  // Forzar redibujado Chart.js tras mostrar el tab
  setTimeout(() => Object.values(charts).forEach(c => c && c.resize && c.resize()), 60);
}

/* ══════════════════════════════════════════════════════
   Carga principal
══════════════════════════════════════════════════════ */
async function cargarEstadisticas() {
  try {
    datos = await apiFetch('/api/cobranzas/stats/dashboard');
    renderHistorico();
    renderActivo();
  } catch (e) {
    toast('Error al cargar estadísticas: ' + e.message, 'error');
  }
}

/* ══════════════════════════════════════════════════════
   TAB: HISTÓRICO
══════════════════════════════════════════════════════ */
function renderHistorico() {
  const h    = datos.historico          || {};  // {por_anio, por_mes, total_historico, ...}
  const otics = datos.por_otic_historico || [];  // [{razon_social, monto_bruto, monto_nc, ...}]

  const porAnio = h.por_anio || [];   // [{anio, monto_bruto, monto_nc, monto_neto, num_facturas, num_nc}]
  const porMes  = h.por_mes  || [];   // [{periodo, anio, mes, num_facturas, monto_bruto}]

  /* ── KPIs ── */
  const totalFac  = h.total_historico    || 0;
  const totalNC   = h.total_nc_historico || 0;
  const totalNeto = totalFac - totalNC;
  const totalDocs = porAnio.reduce((s, a) => s + (a.num_facturas||0) + (a.num_nc||0), 0);

  document.getElementById('kpi-historico').innerHTML = `
    <div class="kpi-card">
      <div class="kpi-label">Total Facturado (histórico)</div>
      <div class="kpi-value">${fmt(totalFac)}</div>
      <div class="kpi-sub">${porAnio.length} años registrados</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Notas de Crédito</div>
      <div class="kpi-value rojo">${fmt(totalNC)}</div>
      <div class="kpi-sub">Descuento total emitido</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Facturación Neta</div>
      <div class="kpi-value verde">${fmt(totalNeto)}</div>
      <div class="kpi-sub">Facturado menos NC</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Total Documentos</div>
      <div class="kpi-value num-lg">${totalDocs.toLocaleString('es-CL')}</div>
      <div class="kpi-sub">Facturas y notas de crédito</div>
    </div>
  `;

  /* ── Tendencia mensual ── */
  if (porMes.length) {
    const labels = porMes.map(r => labelMes(r.periodo));
    mkLine('chTendencia', labels, [{
      label: 'Facturado',
      data: porMes.map(r => r.monto_bruto || 0),
      borderColor: C.primary,
      backgroundColor: 'rgba(26,54,93,.07)',
      fill: true, tension: .35, pointRadius: 2,
    }]);
  }

  /* ── Comparativo anual ── */
  if (porAnio.length) {
    const labels = porAnio.map(a => String(a.anio));
    mkBar('chAnual', labels, [
      { label: 'Facturado', data: porAnio.map(a => a.monto_bruto||0),
        backgroundColor: C.primary, borderRadius: 4 },
      { label: 'NC',        data: porAnio.map(a => a.monto_nc||0),
        backgroundColor: C.red, borderRadius: 4 },
    ]);
  }

  /* ── Tabla OTIC ── */
  oticCache[''] = otics;
  // Poblar selector
  const sel = document.getElementById('selectAnioOtic');
  (h.anios_disponibles || []).forEach(a => {
    const opt = document.createElement('option');
    opt.value = String(a); opt.textContent = a;
    sel.appendChild(opt);
  });
  renderTablaOtic(otics);

  /* ── Donut OTIC ── */
  if (otics.length) {
    const top = otics.slice(0, 8);
    const restoMonto = otics.slice(8).reduce((s, o) => s + (o.monto_bruto||0), 0);
    const lbls = top.map(o => (o.razon_social||'Sin nombre').slice(0, 28));
    const vals = top.map(o => o.monto_bruto||0);
    if (restoMonto > 0) { lbls.push('Otros'); vals.push(restoMonto); }
    mkDonut('chOticDonut', lbls, vals, C.blues.slice(0, lbls.length));
  }
}

function renderTablaOtic(lista) {
  if (!lista.length) {
    document.getElementById('tablaOticWrap').innerHTML =
      '<p style="padding:16px;color:var(--text-muted);font-size:13px">Sin datos</p>';
    return;
  }
  const maxMonto = Math.max(...lista.map(o => o.monto_bruto||0), 1);
  const filas = lista.map((o, i) => {
    const pct = Math.round((o.monto_bruto||0) / maxMonto * 100);
    return `<tr>
      <td style="color:var(--text-muted);font-size:11px">${i+1}</td>
      <td style="font-weight:500">${o.razon_social || '—'}</td>
      <td class="r">${(o.num_facturas||0).toLocaleString()}</td>
      <td class="r">${fmt(o.monto_bruto||0)}</td>
      <td class="r" style="color:var(--estado-vencida)">${o.monto_nc ? fmt(o.monto_nc) : '—'}</td>
      <td style="min-width:110px">
        <div class="mini-bar-wrap">
          <div class="mini-bar"><div class="mini-bar-fill" style="width:${pct}%"></div></div>
          <span class="mini-pct">${pct}%</span>
        </div>
      </td>
    </tr>`;
  }).join('');

  document.getElementById('tablaOticWrap').innerHTML = `
    <div style="overflow-x:auto">
    <table class="stats-table">
      <thead><tr>
        <th style="width:30px">#</th>
        <th>OTIC / Receptor</th>
        <th class="r">Facturas</th>
        <th class="r">Monto Bruto</th>
        <th class="r">NC</th>
        <th style="min-width:110px">Participación</th>
      </tr></thead>
      <tbody>${filas}</tbody>
    </table></div>`;
}

async function cambiarAnioOtic(anio) {
  const wrap = document.getElementById('tablaOticWrap');
  if (oticCache[anio]) { renderTablaOtic(oticCache[anio]); return; }
  wrap.innerHTML = '<div class="ph" style="height:100px"><div class="spin-sm"></div> Cargando...</div>';
  try {
    const url = '/api/cobranzas/stats/historico' + (anio ? '?anio=' + anio : '');
    const res = await apiFetch(url);
    const lista = res.por_otic || [];
    oticCache[anio] = lista;
    renderTablaOtic(lista);
  } catch (e) {
    wrap.innerHTML = '<div style="padding:16px;color:var(--estado-vencida)">Error: ' + e.message + '</div>';
  }
}

/* ══════════════════════════════════════════════════════
   TAB: GESTIÓN ACTIVA
══════════════════════════════════════════════════════ */
function renderActivo() {
  const kpis  = datos.kpis             || {};
  const cm    = datos.cobranza_mensual || [];   // [{periodo, facturado, cobrado, pendiente}]
  const estats= datos.estados          || [];   // [{estado, cantidad, monto}]
  const topC  = datos.top_clientes     || [];   // [{nombre, num_facturas, total_facturado, total_cobrado, total_pendiente, pct_cobrado}]
  const topCu = datos.top_cursos       || [];   // [{curso, num_facturas, total_facturado, num_clientes_distintos}]
  const topO  = datos.top_otics        || [];   // [{razon_social, num_facturas_pendientes, saldo_total_pendiente}]
  const alerts= datos.alertas          || {};   // {mas_de_90_dias:[...], entre_60_90:[...], ...}

  /* ── KPIs ── */
  const pct = kpis.pct_recuperacion ?? 0;
  const dias = kpis.dias_promedio_cobro ?? null;
  document.getElementById('kpi-activo').innerHTML = `
    <div class="kpi-card">
      <div class="kpi-label">Total Facturado 2026+</div>
      <div class="kpi-value">${fmt(kpis.total_facturado||0)}</div>
      <div class="kpi-sub">${(kpis.num_facturas||0)} facturas</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Cobrado</div>
      <div class="kpi-value verde">${fmt(kpis.total_cobrado||0)}</div>
      <div class="kpi-sub">${pct.toFixed(1)}% de recuperación</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Saldo Pendiente</div>
      <div class="kpi-value ambar">${fmt(kpis.total_pendiente||0)}</div>
      <div class="kpi-sub">${(100-pct).toFixed(1)}% por cobrar</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Días Prom. Cobro</div>
      <div class="kpi-value num-lg">${dias !== null ? Number(dias).toFixed(0) : '—'}</div>
      <div class="kpi-sub">días desde emisión factura</div>
    </div>
  `;

  /* ── Alertas ── */
  // Cada bucket es una lista de facturas; calculamos count y sum
  const buckets = [
    { key: 'mas_de_90_dias', label: '> 90 días',   cls: 'critica' },
    { key: 'entre_60_90',    label: '60 – 90 días', cls: 'alta'    },
    { key: 'entre_30_60',    label: '30 – 60 días', cls: 'media'   },
    { key: 'menos_de_30',    label: '< 30 días',    cls: 'baja'    },
  ];
  document.getElementById('alertasGrid').innerHTML = buckets.map(b => {
    const lista = alerts[b.key] || [];
    const monto = lista.reduce((s, f) => s + (f.saldo_pendiente||0), 0);
    return `<div class="alerta-card ${b.cls}">
      <div class="alerta-label">${b.label}</div>
      <div class="alerta-count">${lista.length}</div>
      <div class="alerta-monto">${fmt(monto)}</div>
    </div>`;
  }).join('');

  /* ── Facturado vs Cobrado mensual ── */
  if (cm.length) {
    const labels = cm.map(r => labelMes(r.periodo));
    mkBar('chFacCob', labels, [
      { label: 'Facturado', data: cm.map(r => r.facturado||0),
        backgroundColor: C.primary, borderRadius: 3 },
      { label: 'Cobrado',   data: cm.map(r => r.cobrado||0),
        backgroundColor: C.green,   borderRadius: 3 },
    ]);
  }

  /* ── Estados de cartera (donut por monto) ── */
  if (estats.length) {
    const EST_COLORS = {
      'Pendiente': C.amber,
      'Parcial':   '#d97706',
      'Pagada':    C.green,
      'Anulada':   C.gray,
    };
    mkDonut('chEstados',
      estats.map(e => e.estado + ' (' + (e.cantidad||0) + ')'),
      estats.map(e => e.monto||0),
      estats.map(e => EST_COLORS[e.estado] || C.gray),
    );
  }

  /* ── Clientes horizontal bar ── */
  const top10C = topC.slice(0, 10);
  if (top10C.length) {
    mkBarH('chClientes',
      top10C.map(c => (c.nombre||'Sin asignar').slice(0, 28)),
      top10C.map(c => c.total_facturado||0),
      C.primary,
    );
  }

  /* ── Cursos horizontal bar ── */
  const top10Cu = topCu.slice(0, 10);
  if (top10Cu.length) {
    mkBarH('chCursos',
      top10Cu.map(c => (c.curso||'Sin asignar').slice(0, 28)),
      top10Cu.map(c => c.total_facturado||0),
      C.blue2,
    );
  }

  /* ── Tabla clientes ── */
  const maxC = Math.max(...topC.map(c => c.total_facturado||0), 1);
  document.getElementById('tbClientes').innerHTML = topC.length
    ? topC.slice(0, 20).map((c, i) => {
        const fac = c.total_facturado || 0;
        const cob = c.total_cobrado   || 0;
        const pend= c.total_pendiente || 0;
        const pct = fac > 0 ? Math.round(cob / fac * 100) : 0;
        const barPct = Math.round(fac / maxC * 100);
        const barColor = pct >= 80 ? 'var(--estado-pagada)' : pct >= 40 ? 'var(--estado-parcial)' : 'var(--estado-vencida)';
        return `<tr>
          <td style="color:var(--text-muted);font-size:11px">${i+1}</td>
          <td style="font-weight:500">${c.nombre || '<em style="color:var(--text-muted)">Sin asignar</em>'}</td>
          <td class="r">${(c.num_facturas||0)}</td>
          <td class="r">
            <div class="mini-bar-wrap" style="justify-content:flex-end">
              <span>${fmt(fac)}</span>
              <div class="mini-bar" style="min-width:36px">
                <div class="mini-bar-fill" style="width:${barPct}%"></div>
              </div>
            </div>
          </td>
          <td class="r" style="color:var(--estado-pagada)">${fmt(cob)}</td>
          <td class="r" style="color:var(--estado-parcial)">${fmt(pend)}</td>
          <td>
            <div class="mini-bar-wrap">
              <div class="mini-bar">
                <div class="mini-bar-fill" style="width:${pct}%;background:${barColor}"></div>
              </div>
              <span class="mini-pct">${pct}%</span>
            </div>
          </td>
        </tr>`;
      }).join('')
    : '<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-muted)">Sin clientes asignados en facturas 2026+</td></tr>';

  /* ── Tabla cursos ── */
  const maxCu = Math.max(...topCu.map(c => c.total_facturado||0), 1);
  document.getElementById('tbCursos').innerHTML = topCu.length
    ? topCu.slice(0, 20).map((c, i) => {
        const barPct = Math.round((c.total_facturado||0) / maxCu * 100);
        return `<tr>
          <td style="color:var(--text-muted);font-size:11px">${i+1}</td>
          <td style="font-weight:500">${c.curso || '<em style="color:var(--text-muted)">Sin asignar</em>'}</td>
          <td class="r">${(c.num_facturas||0)}</td>
          <td class="r">${(c.num_clientes_distintos||0)}</td>
          <td class="r">
            <div class="mini-bar-wrap" style="justify-content:flex-end">
              <span>${fmt(c.total_facturado||0)}</span>
              <div class="mini-bar" style="min-width:36px">
                <div class="mini-bar-fill" style="width:${barPct}%;background:var(--secondary, #2b6cb0)"></div>
              </div>
            </div>
          </td>
        </tr>`;
      }).join('')
    : '<tr><td colspan="5" style="text-align:center;padding:24px;color:var(--text-muted)">Sin cursos asignados en facturas 2026+</td></tr>';

  /* ── Tabla OTICs con pendiente ── */
  const maxOP = Math.max(...topO.map(o => o.saldo_total_pendiente||0), 1);
  document.getElementById('tbOticPend').innerHTML = topO.length
    ? topO.slice(0, 15).map((o, i) => {
        const pct = Math.round((o.saldo_total_pendiente||0) / maxOP * 100);
        return `<tr>
          <td style="color:var(--text-muted);font-size:11px">${i+1}</td>
          <td style="font-weight:500">${o.razon_social || '—'}</td>
          <td class="r">${(o.num_facturas_pendientes||0)}</td>
          <td class="r" style="color:var(--estado-parcial);font-weight:600">${fmt(o.saldo_total_pendiente||0)}</td>
          <td>
            <div class="mini-bar-wrap">
              <div class="mini-bar">
                <div class="mini-bar-fill" style="width:${pct}%;background:var(--estado-parcial)"></div>
              </div>
              <span class="mini-pct">${pct}%</span>
            </div>
          </td>
        </tr>`;
      }).join('')
    : '<tr><td colspan="5" style="text-align:center;padding:24px;color:var(--text-muted)">Sin OTICs con saldo pendiente</td></tr>';
}

/* ══════════════════════════════════════════════════════
   Init
══════════════════════════════════════════════════════ */
document.addEventListener('DOMContentLoaded', () => {
  lucide.createIcons();
  cargarEstadisticas();
});
</script>
{% endblock %}
