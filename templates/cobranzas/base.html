<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="csrf-token" content="{{ csrf_token }}">
<title>{% block title %}Cobranzas{% endblock %} — Tecnipro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
<style>
:root {
  --primary:         #1a365d;
  --primary-light:   #2c5282;
  --primary-lighter: #ebf4ff;
  --primary-hover:   #153050;
  --bg-main:         #f7f8fc;
  --bg-card:         #ffffff;
  --text-primary:    #1a202c;
  --text-secondary:  #718096;
  --text-muted:      #a0aec0;
  --border:          #e2e8f0;
  --border-light:    #f0f4f8;
  --shadow-sm:       0 1px 3px rgba(0,0,0,.06);
  --shadow:          0 2px 8px rgba(0,0,0,.08);
  --shadow-md:       0 4px 16px rgba(0,0,0,.10);
  --radius:          10px;
  --radius-sm:       6px;
  --sidebar-w:       220px;
  --header-h:        56px;
  /* Estado semáforo */
  --c-pendiente:     #e53e3e;
  --c-pendiente-bg:  #fff5f5;
  --c-parcial:       #c05621;
  --c-parcial-bg:    #fffaf0;
  --c-pagada:        #276749;
  --c-pagada-bg:     #f0fff4;
  --c-anulada:       #718096;
  --c-anulada-bg:    #f7fafc;
  /* Montos */
  --c-positivo:      #276749;
  --c-negativo:      #9b2c2c;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  color: var(--text-primary);
  background: var(--bg-main);
  display: flex;
  min-height: 100vh;
}
/* ── Sidebar ── */
.sidebar {
  position: fixed; top: 0; left: 0; bottom: 0;
  width: var(--sidebar-w);
  background: var(--primary);
  display: flex; flex-direction: column;
  z-index: 100;
}
.sidebar-logo {
  padding: 18px 20px 14px;
  border-bottom: 1px solid rgba(255,255,255,.1);
}
.sidebar-logo a {
  display: flex; align-items: center; gap: 10px;
  text-decoration: none; color: white;
}
.sidebar-logo .logo-icon {
  width: 32px; height: 32px;
  background: rgba(255,255,255,.15);
  border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.sidebar-logo .logo-text { font-size: 13px; font-weight: 700; line-height: 1.2; }
.sidebar-logo .logo-sub  { font-size: 11px; color: rgba(255,255,255,.6); }
.sidebar-nav { flex: 1; padding: 12px 0; overflow-y: auto; }
.sidebar-section-label {
  font-size: 10px; font-weight: 700; letter-spacing: .08em;
  color: rgba(255,255,255,.4); text-transform: uppercase;
  padding: 12px 20px 6px;
}
.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 20px; cursor: pointer;
  color: rgba(255,255,255,.75); font-size: 13.5px; font-weight: 500;
  text-decoration: none; transition: all .15s;
  border-left: 3px solid transparent;
}
.nav-item:hover { background: rgba(255,255,255,.08); color: white; }
.nav-item.active {
  background: rgba(255,255,255,.12); color: white;
  border-left-color: #63b3ed;
}
.nav-item i[data-lucide] { width: 16px; height: 16px; flex-shrink: 0; }
.sidebar-footer {
  padding: 12px 20px; border-top: 1px solid rgba(255,255,255,.1);
  font-size: 12px; color: rgba(255,255,255,.4);
}
.sidebar-user {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 20px; background: rgba(0,0,0,.15);
}
.sidebar-user .avatar {
  width: 28px; height: 28px; border-radius: 50%;
  background: rgba(255,255,255,.2);
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700; color: white;
}
.sidebar-user .user-info { flex: 1; min-width: 0; }
.sidebar-user .user-name { font-size: 12px; font-weight: 600; color: white; truncate; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
.sidebar-user .user-role { font-size: 11px; color: rgba(255,255,255,.5); }
/* ── Main layout ── */
.main-wrap {
  margin-left: var(--sidebar-w);
  flex: 1; display: flex; flex-direction: column; min-height: 100vh;
}
.topbar {
  height: var(--header-h);
  background: var(--bg-card); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 16px;
  padding: 0 24px; position: sticky; top: 0; z-index: 50;
}
.topbar-breadcrumb {
  display: flex; align-items: center; gap: 6px;
  font-size: 13px; color: var(--text-secondary);
}
.topbar-breadcrumb a { color: var(--text-secondary); text-decoration: none; }
.topbar-breadcrumb a:hover { color: var(--primary); }
.topbar-breadcrumb .sep { color: var(--border); }
.topbar-breadcrumb .current { color: var(--text-primary); font-weight: 600; }
.topbar-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
.btn-exit {
  display: flex; align-items: center; gap: 6px;
  padding: 6px 12px; border-radius: var(--radius-sm);
  color: var(--text-secondary); font-size: 12px; font-weight: 500;
  text-decoration: none; border: 1px solid var(--border);
  transition: all .15s;
}
.btn-exit:hover { border-color: var(--primary); color: var(--primary); }
/* ── Page content ── */
.page-content {
  flex: 1; padding: 24px;
  max-width: 1400px; width: 100%;
}
.page-header {
  display: flex; align-items: flex-start; justify-content: space-between;
  margin-bottom: 24px; gap: 16px;
}
.page-title { font-size: 22px; font-weight: 700; color: var(--text-primary); }
.page-subtitle { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
/* ── Cards ── */
.card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); box-shadow: var(--shadow-sm);
}
.card-header {
  padding: 16px 20px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.card-title {
  font-size: 14px; font-weight: 700; color: var(--text-primary);
  display: flex; align-items: center; gap: 8px;
}
.card-title i[data-lucide] { width: 15px; height: 15px; color: var(--primary); }
.card-body { padding: 20px; }
/* ── KPI cards ── */
.kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
.kpi-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 18px 20px;
  box-shadow: var(--shadow-sm);
}
.kpi-card .kpi-label { font-size: 11.5px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: .04em; margin-bottom: 8px; }
.kpi-card .kpi-value { font-size: 24px; font-weight: 700; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; line-height: 1.1; }
.kpi-card .kpi-sub { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
.kpi-card .kpi-icon {
  width: 36px; height: 36px; border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 12px;
}
/* ── Tables ── */
.table-wrap { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
thead th {
  background: var(--primary); color: white;
  padding: 10px 14px; text-align: left;
  font-size: 11.5px; font-weight: 700; letter-spacing: .03em;
  white-space: nowrap;
}
thead th.num { text-align: right; }
tbody tr { border-bottom: 1px solid var(--border-light); transition: background .1s; }
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: var(--primary-lighter); }
tbody td { padding: 10px 14px; vertical-align: middle; }
tbody td.num {
  text-align: right; font-family: 'JetBrains Mono', monospace;
  font-size: 12.5px; white-space: nowrap;
}
tbody td.mono { font-family: 'JetBrains Mono', monospace; font-size: 12.5px; }
.table-empty { text-align: center; padding: 40px; color: var(--text-secondary); }
/* ── Badges ── */
.badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 8px; border-radius: 100px;
  font-size: 11.5px; font-weight: 600; white-space: nowrap;
}
.badge-pendiente { background: var(--c-pendiente-bg); color: var(--c-pendiente); }
.badge-parcial   { background: var(--c-parcial-bg);   color: var(--c-parcial);   }
.badge-pagada    { background: var(--c-pagada-bg);     color: var(--c-pagada);    }
.badge-anulada   { background: var(--c-anulada-bg);    color: var(--c-anulada);   }
/* ── Buttons ── */
.btn {
  display: inline-flex; align-items: center; gap: 7px;
  padding: 8px 16px; border-radius: var(--radius-sm);
  font-size: 13px; font-weight: 600; cursor: pointer;
  transition: all .15s; border: 1px solid transparent;
  text-decoration: none; white-space: nowrap;
}
.btn i[data-lucide] { width: 14px; height: 14px; flex-shrink: 0; }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-hover); }
.btn-secondary { background: var(--bg-card); color: var(--text-primary); border-color: var(--border); }
.btn-secondary:hover { border-color: var(--primary); color: var(--primary); }
.btn-danger { background: #fff5f5; color: #c53030; border-color: #fed7d7; }
.btn-danger:hover { background: #fed7d7; }
.btn-sm { padding: 5px 10px; font-size: 12px; }
.btn-xs { padding: 3px 8px; font-size: 11px; }
/* ── Forms ── */
.form-group { margin-bottom: 16px; }
.form-label { display: block; font-size: 12px; font-weight: 700; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: .04em; }
.form-control {
  display: block; width: 100%; padding: 8px 12px;
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  font-size: 13.5px; color: var(--text-primary);
  background: var(--bg-card); transition: border-color .15s;
  font-family: 'DM Sans', sans-serif;
}
.form-control:focus { outline: none; border-color: var(--primary-light); box-shadow: 0 0 0 3px var(--primary-lighter); }
.form-control.mono { font-family: 'JetBrains Mono', monospace; }
select.form-control { cursor: pointer; }
/* ── Tabs ── */
.tabs { display: flex; gap: 2px; border-bottom: 2px solid var(--border); margin-bottom: 24px; }
.tab-btn {
  padding: 10px 18px; border: none; background: none; cursor: pointer;
  font-size: 13.5px; font-weight: 600; color: var(--text-secondary);
  border-bottom: 2px solid transparent; margin-bottom: -2px;
  transition: all .15s; display: flex; align-items: center; gap: 7px;
}
.tab-btn i[data-lucide] { width: 14px; height: 14px; }
.tab-btn:hover { color: var(--primary); }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
.tab-panel { display: none; }
.tab-panel.active { display: block; }
/* ── Modal ── */
.modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.45); z-index: 200;
  align-items: center; justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--bg-card); border-radius: var(--radius);
  box-shadow: var(--shadow-md); width: 90%; max-width: 540px;
  max-height: 90vh; overflow-y: auto;
}
.modal-header {
  padding: 18px 24px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.modal-title { font-size: 16px; font-weight: 700; }
.modal-close { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 4px; border-radius: 4px; }
.modal-close:hover { background: var(--border-light); }
.modal-body { padding: 24px; }
.modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
/* ── Toast ── */
#toast-container {
  position: fixed; bottom: 24px; right: 24px;
  display: flex; flex-direction: column; gap: 8px;
  z-index: 1000;
}
.toast {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 16px; border-radius: var(--radius-sm);
  box-shadow: var(--shadow-md); font-size: 13px; font-weight: 500;
  animation: slideIn .2s ease;
  max-width: 380px;
}
.toast-success { background: #f0fff4; color: #276749; border: 1px solid #c6f6d5; }
.toast-error   { background: #fff5f5; color: #c53030; border: 1px solid #fed7d7; }
.toast-info    { background: var(--primary-lighter); color: var(--primary); border: 1px solid #bee3f8; }
.toast i[data-lucide] { width: 16px; height: 16px; flex-shrink: 0; }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: none; opacity: 1; } }
/* ── Filters bar ── */
.filters-bar { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 16px; }
.filters-bar .form-group { margin-bottom: 0; }
.filters-bar .form-control { min-width: 140px; }
/* ── Inline edit ── */
.inline-edit { position: relative; }
.inline-edit-val { cursor: pointer; border-bottom: 1px dashed var(--border); min-width: 60px; display: inline-block; }
.inline-edit-val:hover { border-bottom-color: var(--primary); color: var(--primary); }
.inline-edit-input { font-size: 13px; padding: 3px 6px; border: 1px solid var(--primary-light); border-radius: 4px; width: 100%; }
/* ── Pagination ── */
.pagination { display: flex; align-items: center; gap: 8px; justify-content: center; margin-top: 20px; }
.page-btn { padding: 6px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); cursor: pointer; font-size: 13px; font-weight: 500; }
.page-btn:hover { border-color: var(--primary); color: var(--primary); }
.page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
.page-btn:disabled { opacity: .4; cursor: not-allowed; }
/* ── Spinner ── */
.spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin .7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-state { text-align: center; padding: 40px; color: var(--text-secondary); }
/* ── Alert boxes ── */
.alert { padding: 12px 16px; border-radius: var(--radius-sm); font-size: 13px; margin-bottom: 16px; display: flex; gap: 10px; align-items: flex-start; }
.alert i[data-lucide] { width: 16px; height: 16px; flex-shrink: 0; margin-top: 1px; }
.alert-warning { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }
.alert-info    { background: var(--primary-lighter); color: var(--primary); border: 1px solid #bee3f8; }
.alert-success { background: #f0fff4; color: #276749; border: 1px solid #c6f6d5; }
.alert-error   { background: #fff5f5; color: #c53030; border: 1px solid #fed7d7; }
/* ── Footer ── */
.page-footer {
  text-align: center; padding: 16px 24px;
  font-size: 11.5px; color: var(--text-muted);
  border-top: 1px solid var(--border-light);
}
/* ── Responsive ── */
@media (max-width: 768px) {
  .sidebar { transform: translateX(-100%); }
  .main-wrap { margin-left: 0; }
}
</style>
{% block extra_styles %}{% endblock %}
</head>
<body>
<!-- ═══ Sidebar ═══ -->
<nav class="sidebar">
  <div class="sidebar-logo">
    <a href="/cobranzas/">
      <div class="logo-icon"><i data-lucide="landmark" style="width:16px;height:16px;color:white"></i></div>
      <div>
        <div class="logo-text">Tecnipro</div>
        <div class="logo-sub">Sistema de Cobranzas</div>
      </div>
    </a>
  </div>

  <div class="sidebar-nav">
    <div class="sidebar-section-label">Módulo</div>
    <a href="/cobranzas/" class="nav-item {% if request.path in ['/cobranzas/', '/cobranzas'] %}active{% endif %}">
      <i data-lucide="layout-dashboard"></i> Dashboard
    </a>
    <a href="/cobranzas/facturas" class="nav-item {% if '/facturas' in request.path %}active{% endif %}">
      <i data-lucide="file-text"></i> Facturas
    </a>
    <a href="/cobranzas/pagos" class="nav-item {% if '/pagos' in request.path %}active{% endif %}">
      <i data-lucide="credit-card"></i> Pagos
    </a>
    <a href="/cobranzas/clientes" class="nav-item {% if '/clientes' in request.path %}active{% endif %}">
      <i data-lucide="users"></i> Clientes
    </a>
    <div class="sidebar-section-label">Herramientas</div>
    <a href="/cobranzas/importar" class="nav-item {% if '/importar' in request.path %}active{% endif %}">
      <i data-lucide="upload"></i> Importar CSV
    </a>
    <a href="/cobranzas/estadisticas" class="nav-item {% if '/estadisticas' in request.path %}active{% endif %}">
      <i data-lucide="bar-chart-3"></i> Estadísticas
    </a>
    <div class="sidebar-section-label">Sistema</div>
    <a href="/" class="nav-item">
      <i data-lucide="arrow-left"></i> Volver al Hub
    </a>
  </div>

  <div class="sidebar-user">
    <div class="avatar">{{ current_user.nombre[0].upper() if current_user.nombre else 'A' }}</div>
    <div class="user-info">
      <div class="user-name">{{ current_user.nombre }}</div>
      <div class="user-role">Administrador</div>
    </div>
  </div>
  <div class="sidebar-footer">Sistema de Cobranzas Tecnipro<br>Acceso restringido a administradores</div>
</nav>

<!-- ═══ Main ═══ -->
<div class="main-wrap">
  <header class="topbar">
    <div class="topbar-breadcrumb">
      <a href="/cobranzas/"><i data-lucide="landmark" style="width:13px;height:13px"></i> Cobranzas</a>
      {% block breadcrumb %}{% endblock %}
    </div>
    <div class="topbar-right">
      <a href="/" class="btn-exit">
        <i data-lucide="log-out" style="width:13px;height:13px"></i> Salir del módulo
      </a>
    </div>
  </header>

  <main class="page-content">
    {% block content %}{% endblock %}
  </main>

  <footer class="page-footer">
    Sistema de Cobranzas Tecnipro — Acceso restringido a administradores
  </footer>
</div>

<!-- ═══ Toast container ═══ -->
<div id="toast-container"></div>

<script>
/* ── Global utilities ── */
const CSRF = document.querySelector('meta[name="csrf-token"]')?.content || '';

function apiFetch(url, opts = {}) {
  const method = (opts.method || 'GET').toUpperCase();
  const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
  if (method !== 'GET') headers['X-CSRFToken'] = CSRF;
  return fetch(url, { ...opts, method, headers });
}

function toast(msg, type = 'info', ms = 4000) {
  const icons = { success: 'check-circle', error: 'x-circle', info: 'info' };
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.innerHTML = `<i data-lucide="${icons[type] || 'info'}"></i><span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(el);
  lucide.createIcons({ nodes: [el] });
  setTimeout(() => el.remove(), ms);
}

function fmt(n) {
  if (n == null || n === '') return '—';
  return '$' + Math.round(n).toLocaleString('es-CL');
}

function fmtNum(n) {
  if (n == null) return '—';
  return Math.round(n).toLocaleString('es-CL');
}

const MESES = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
function fmtFecha(s) {
  if (!s) return '—';
  const [y, m, d] = s.substring(0, 10).split('-');
  return `${parseInt(d)} ${MESES[parseInt(m) - 1]} ${y}`;
}

function badgeEstado(e) {
  const m = { Pendiente:'pendiente', Parcial:'parcial', Pagada:'pagada', Anulada:'anulada' };
  return `<span class="badge badge-${m[e] || 'anulada'}">${e}</span>`;
}

function modalOpen(id)  { document.getElementById(id).classList.add('open'); }
function modalClose(id) { document.getElementById(id).classList.remove('open'); }

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const group = btn.closest('[data-tabs]') || btn.parentElement;
    const target = btn.dataset.tab;
    group.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const content = btn.closest('.card, main, section') || document;
    content.querySelectorAll('.tab-panel').forEach(p => {
      p.classList.toggle('active', p.id === target);
    });
    if (typeof onTabChange === 'function') onTabChange(target);
  });
});

// Init Lucide icons
lucide.createIcons();
</script>
{% block scripts %}{% endblock %}
</body>
</html>
