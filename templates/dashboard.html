<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Sistema de Gestión de Capacitación - Instituto Tecnipro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        :root {
            --slate-950: #020617;
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-500: #64748b;
            --slate-400: #94a3b8;
            --slate-300: #cbd5e1;
            --slate-200: #e2e8f0;
            --slate-100: #f1f5f9;
            --slate-50: #f8fafc;
            --white: #ffffff;
            --blue-700: #1d4ed8;
            --blue-600: #2563eb;
            --blue-500: #3b82f6;
            --blue-400: #60a5fa;
            --blue-100: #dbeafe;
            --blue-50: #eff6ff;
            --green-600: #16a34a;
            --green-500: #22c55e;
            --green-100: #dcfce7;
            --green-50: #f0fdf4;
            --red-600: #dc2626;
            --red-500: #ef4444;
            --red-100: #fee2e2;
            --red-50: #fef2f2;
            --amber-600: #d97706;
            --amber-500: #f59e0b;
            --amber-100: #fef3c7;
            --orange-700: #c2410c;
            --orange-200: #fed7aa;
            --orange-50: #fff7ed;
            --amber-50: #fffbeb;
            --teal-600: #0d9488;
            --teal-500: #14b8a6;
            --teal-100: #ccfbf1;
            --purple-600: #7c3aed;
            --purple-500: #8b5cf6;
            --purple-100: #ede9fe;
            --radius: 16px;
            --radius-sm: 10px;
            --radius-xs: 6px;
            --shadow: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,.07), 0 2px 4px -2px rgba(0,0,0,.05);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.08), 0 4px 6px -4px rgba(0,0,0,.05);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,.1), 0 8px 10px -6px rgba(0,0,0,.06);
            --shadow-glow: 0 0 20px rgba(37,99,235,.12);
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(145deg, #f0f4f8 0%, #e8edf5 50%, #f0f4f8 100%);
            color: var(--slate-800);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        .app { max-width: 1520px; margin: 0 auto; padding: 1.5rem; }

        /* ── HEADER ── */
        .header {
            background: linear-gradient(135deg, #0c1222 0%, #162036 40%, #1a2d52 70%, #1e3a5f 100%);
            color: white;
            padding: 2rem 2.5rem;
            border-radius: 20px;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 32px rgba(12,18,34,.35), 0 2px 8px rgba(0,0,0,.12);
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                radial-gradient(ellipse 600px 300px at 10% 90%, rgba(37,99,235,.12) 0%, transparent 70%),
                radial-gradient(ellipse 400px 200px at 90% 20%, rgba(14,184,166,.08) 0%, transparent 70%),
                repeating-linear-gradient(90deg, transparent, transparent 80px, rgba(255,255,255,.015) 80px, rgba(255,255,255,.015) 81px),
                repeating-linear-gradient(0deg, transparent, transparent 80px, rgba(255,255,255,.015) 80px, rgba(255,255,255,.015) 81px);
        }
        .header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(59,130,246,.06) 0%, transparent 70%);
            pointer-events: none;
        }
        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
            gap: 2rem;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex: 1;
            min-width: 0;
        }
        .logo-box {
            width: 200px;
            height: 58px;
            flex-shrink: 0;
            background: linear-gradient(135deg, rgba(255,255,255,.97) 0%, rgba(241,245,249,.95) 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--slate-800);
            text-align: center;
            line-height: 1.3;
            box-shadow: 0 4px 16px rgba(0,0,0,.15), inset 0 1px 0 rgba(255,255,255,.8);
            border: 1px solid rgba(255,255,255,.3);
        }
        .header-text {
            flex: 1;
            min-width: 0;
        }
        .header-text h1 {
            font-size: 1.6rem;
            font-weight: 800;
            letter-spacing: -.03em;
            margin-bottom: .3rem;
            background: linear-gradient(135deg, #ffffff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-text p {
            font-size: .85rem;
            opacity: .55;
            font-weight: 400;
            letter-spacing: .01em;
        }

        /* Header Right Section */
        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1rem;
        }

        /* Info Cards Container */
        .header-info {
            display: flex;
            gap: .75rem;
            align-items: center;
        }

        /* Info Box Styles */
        .info-box {
            background: rgba(255,255,255,.08);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,.12);
            border-radius: var(--radius-sm);
            padding: .65rem 1rem;
            font-size: .82rem;
            display: flex;
            flex-direction: column;
            gap: .25rem;
            box-shadow: 0 2px 12px rgba(0,0,0,.12);
            transition: background .2s;
        }
        .info-box:hover {
            background: rgba(255,255,255,.12);
        }

        .info-box-row {
            display: flex;
            align-items: center;
            gap: .5rem;
            white-space: nowrap;
        }

        .info-box-row i {
            opacity: .7;
            width: 14px;
            text-align: center;
        }

        .info-box strong {
            font-weight: 600;
        }

        .user-role-badge {
            display: inline-block;
            background: rgba(255,255,255,.2);
            padding: .15rem .5rem;
            border-radius: 4px;
            font-size: .7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .02em;
            margin-left: .35rem;
        }

        /* Action Buttons Container - WRAPPER (2 filas) */
        .header-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Individual Row dentro de header-actions */
        .header-actions-row {
            display: flex;
            gap: 0.5rem;
            align-items: stretch;
        }
        .header-actions-row > * {
            flex: 1 1 0;
            min-width: 0;
            justify-content: center;
            text-align: center;
        }

        /* Fila de navegación (Volver, Logout) */
        .header-actions-nav {
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            padding-top: 0.75rem;
        }

        /* ── KPI CARDS ── */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .kpi-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 1.25rem 1.5rem;
            box-shadow: var(--shadow), 0 0 0 1px rgba(0,0,0,.03);
            border: none;
            transition: transform .25s cubic-bezier(.34,1.56,.64,1), box-shadow .25s;
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--blue-500), var(--teal-500));
            opacity: .6;
        }
        .kpi-card:nth-child(3)::before { background: linear-gradient(90deg, var(--green-500), var(--teal-500)); }
        .kpi-card:nth-child(4)::before { background: linear-gradient(90deg, var(--red-500), var(--amber-500)); }
        .kpi-card:nth-child(5)::before { background: linear-gradient(90deg, var(--amber-500), #f97316); }
        .kpi-card:nth-child(6)::before { background: linear-gradient(90deg, var(--red-600), var(--red-500)); }
        .kpi-card:nth-child(7)::before { background: linear-gradient(90deg, var(--teal-500), var(--blue-500)); }
        .kpi-card:nth-child(8)::before { background: linear-gradient(90deg, var(--purple-500), var(--blue-500)); }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg), var(--shadow-glow); }
        .kpi-label { font-size: .72rem; font-weight: 600; color: var(--slate-500); text-transform: uppercase; letter-spacing: .06em; margin-bottom: .4rem; }
        .kpi-value { font-size: 2.1rem; font-weight: 800; line-height: 1.1; font-family: 'JetBrains Mono', monospace; }
        .kpi-sub { font-size: .75rem; color: var(--slate-400); margin-top: .3rem; font-weight: 500; }
        .kpi-value.blue { color: var(--blue-600); }
        .kpi-value.green { color: var(--green-600); }
        .kpi-value.red { color: var(--red-600); }
        .kpi-value.amber { color: var(--amber-600); }
        .kpi-value.teal { color: var(--teal-600); }
        .kpi-value.purple { color: var(--purple-600); }

        /* ── FILTERS BAR ── */
        .filters-bar {
            background: var(--white);
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow), 0 0 0 1px rgba(0,0,0,.03);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-group { display:flex; align-items:center; gap:.5rem; }
        .filter-group label { font-size:.82rem; font-weight:600; color:var(--slate-600); white-space:nowrap; }
        .filter-select, .filter-input {
            padding: .5rem .85rem;
            border: 1px solid var(--slate-300);
            border-radius: var(--radius-xs);
            font-size: .85rem;
            font-family: inherit;
            color: var(--slate-700);
            background: var(--white);
            transition: border-color .2s;
        }
        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--blue-500);
            box-shadow: 0 0 0 3px rgba(59,130,246,.12);
        }
        .filter-input { width: 220px; }
        .filter-input::placeholder { color: var(--slate-400); }
        .btn-clear {
            padding: .45rem .85rem;
            border: 1px solid var(--slate-300);
            border-radius: var(--radius-xs);
            background: var(--white);
            color: var(--slate-600);
            font-size: .82rem;
            font-family: inherit;
            cursor: pointer;
            transition: all .2s;
        }
        .btn-clear:hover { background: var(--slate-100); border-color: var(--slate-400); }

        /* ── ACTION BUTTONS ── */
        .btn-action {
            padding: .55rem 1.1rem;
            border-radius: var(--radius-xs);
            font-size: .88rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all .2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            border: none;
        }
        .btn-back {
            background: rgba(255,255,255,.15);
            color: white;
            border: 1px solid rgba(255,255,255,.25);
        }
        .btn-back:hover {
            background: rgba(255,255,255,.25);
            border-color: rgba(255,255,255,.4);
        }
        .btn-logout {
            background: rgba(239,68,68,.9);
            color: white;
            border: 1px solid rgba(220,38,38,.8);
        }
        .btn-logout:hover {
            background: var(--red-600);
            box-shadow: 0 4px 12px rgba(220,38,38,.3);
        }
        .btn-excel {
            background: #217346;
            color: white;
            border: 1px solid #1d5f3a;
        }
        .btn-excel:hover {
            background: #1a5c37;
            box-shadow: 0 4px 12px rgba(33,115,70,.3);
        }
        .btn-excel-secondary {
            background: #48bb78;
            color: white;
            border: 1px solid #38a169;
        }
        .btn-excel-secondary:hover {
            background: #38a169;
            box-shadow: 0 4px 12px rgba(72,187,120,.3);
        }
        .btn-excel-secondary:disabled {
            background: var(--slate-300);
            border-color: var(--slate-400);
            color: var(--slate-500);
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-refresh {
            background: var(--teal-600);
            color: white;
            border: 1px solid var(--teal-500);
        }
        .btn-refresh:hover {
            background: var(--teal-500);
            box-shadow: 0 4px 12px rgba(13,148,136,.3);
        }
        .btn-refresh:disabled {
            background: var(--slate-300);
            border-color: var(--slate-400);
            color: var(--slate-500);
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-refresh-select {
            background: linear-gradient(135deg, #0f766e, #0891b2);
            color: white;
            border: 1px solid #0f766e;
        }
        .btn-refresh-select:hover {
            background: linear-gradient(135deg, #0d9488, #06b6d4);
            box-shadow: 0 4px 12px rgba(15,118,110,.3);
        }
        .btn-refresh-full {
            background: linear-gradient(135deg, #1d4ed8, #7c3aed);
            color: white;
            border: 1px solid #1d4ed8;
        }
        .btn-refresh-full:hover {
            background: linear-gradient(135deg, #2563eb, #8b5cf6);
            box-shadow: 0 4px 12px rgba(29,78,216,.3);
        }
        .btn-refresh-full:disabled {
            background: var(--slate-300);
            border-color: var(--slate-400);
            color: var(--slate-500);
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-coordinadores {
            background: linear-gradient(135deg, #7c3aed, #d97706);
            color: white;
            border: 1px solid #7c3aed;
        }
        .btn-coordinadores:hover {
            background: linear-gradient(135deg, #8b5cf6, #f59e0b);
            box-shadow: 0 4px 12px rgba(124,58,237,.3);
        }
        .btn-cancel {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            border: 1px solid #dc2626;
        }
        .btn-cancel:hover {
            background: linear-gradient(135deg, #ef4444, #f87171);
            box-shadow: 0 4px 12px rgba(220,38,38,.3);
        }
        .data-age-warning {
            background: var(--amber-100);
            color: var(--amber-600);
            padding: .4rem .75rem;
            border-radius: var(--radius-xs);
            font-size: .75rem;
            font-weight: 600;
            border: 1px solid var(--amber-500);
        }

        /* ── MODAL COORDINADORES ── */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            z-index: 9999;
            animation: fadeIn .2s ease;
        }
        .modal-overlay.active { display: flex; align-items: center; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-xl);
            max-width: 1050px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp .3s ease;
        }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--slate-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--slate-900);
            margin: 0;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--slate-500);
            cursor: pointer;
            padding: .25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-xs);
            transition: all .2s;
        }
        .modal-close:hover { background: var(--slate-100); color: var(--slate-900); }
        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
        }
        .coord-form {
            background: var(--slate-50);
            border-radius: var(--radius-sm);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--slate-200);
        }
        .coord-form h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--slate-800);
            margin-bottom: 1rem;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-size: .85rem;
            font-weight: 600;
            color: var(--slate-700);
            margin-bottom: .35rem;
        }
        .form-group input {
            padding: .6rem .85rem;
            border: 1px solid var(--slate-300);
            border-radius: var(--radius-xs);
            font-size: .9rem;
            transition: all .2s;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--blue-500);
            box-shadow: 0 0 0 3px rgba(37,99,235,.1);
        }
        .coord-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 1px solid var(--slate-200);
        }
        .coord-table thead {
            background: var(--slate-100);
        }
        .coord-table th {
            padding: .85rem 1rem;
            text-align: left;
            font-size: .85rem;
            font-weight: 600;
            color: var(--slate-700);
            border-bottom: 2px solid var(--slate-200);
        }
        .coord-table td {
            padding: .85rem 1rem;
            border-bottom: 1px solid var(--slate-100);
            font-size: .9rem;
            color: var(--slate-700);
        }
        .coord-table tbody tr:hover {
            background: var(--slate-50);
        }
        .coord-actions {
            display: flex;
            gap: .5rem;
        }
        .btn-icon {
            background: none;
            border: 1px solid var(--slate-300);
            border-radius: var(--radius-xs);
            padding: .4rem .6rem;
            cursor: pointer;
            font-size: .85rem;
            transition: all .2s;
            color: var(--slate-600);
        }
        .btn-icon:hover { background: var(--slate-100); }
        .btn-icon.btn-edit:hover { border-color: var(--blue-500); color: var(--blue-600); }
        .btn-icon.btn-delete:hover { border-color: var(--red-500); color: var(--red-600); }
        .btn-icon.btn-key:hover { border-color: var(--amber-500); color: var(--amber-600); }
        .course-badge {
            display: inline-block;
            background: var(--blue-50);
            color: var(--blue-700);
            border: 1px solid var(--blue-200);
            border-radius: 4px;
            padding: .15rem .45rem;
            font-size: .75rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            margin: .1rem .15rem;
        }
        .btn-primary {
            background: var(--blue-600);
            color: white;
            border: none;
            padding: .65rem 1.25rem;
            border-radius: var(--radius-xs);
            font-size: .9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
        }
        .btn-primary:hover {
            background: var(--blue-700);
            box-shadow: 0 4px 12px rgba(37,99,235,.3);
        }
        .btn-secondary {
            background: var(--slate-200);
            color: var(--slate-700);
            border: none;
            padding: .65rem 1.25rem;
            border-radius: var(--radius-xs);
            font-size: .9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
        }
        .btn-secondary:hover {
            background: var(--slate-300);
        }

        /* ── COURSE CHECKBOXES ── */
        .course-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: .5rem;
        }

        /* ── COURSE SECTIONS ── */
        .course-section {
            background: var(--white);
            border-radius: var(--radius);
            margin-bottom: 1.25rem;
            box-shadow: var(--shadow), 0 0 0 1px rgba(0,0,0,.03);
            overflow: hidden;
            transition: box-shadow .3s;
        }
        .course-section.open {
            box-shadow: var(--shadow-md), 0 0 0 1px rgba(37,99,235,.08);
        }
        .course-header {
            padding: 1.25rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background .2s;
            user-select: none;
        }
        .course-header:hover { background: var(--slate-50); }
        .course-header-left { display:flex; align-items:center; gap:1rem; flex:1; min-width:0; }
        .course-indicator {
            width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
        }
        .ci-active { background: var(--green-500); box-shadow: 0 0 8px rgba(34,197,94,.4); }
        .ci-finished { background: var(--slate-400); }
        .ci-warning { background: var(--amber-500); box-shadow: 0 0 8px rgba(245,158,11,.4); }
        .ci-danger { background: var(--red-500); box-shadow: 0 0 8px rgba(239,68,68,.4); }
        .course-title { font-weight: 700; font-size: 1rem; color: var(--slate-800); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .course-meta { display:flex; gap:1.5rem; align-items:center; flex-shrink:0; }
        .course-meta-item { display:flex; align-items:center; gap:.35rem; font-size:.8rem; color:var(--slate-500); }
        .course-meta-item i { font-size:.75rem; }
        .course-badges { display:flex; gap:.5rem; flex-shrink:0; }
        .badge {
            padding: .2rem .65rem;
            border-radius: 999px;
            font-size: .72rem;
            font-weight: 600;
            letter-spacing: .02em;
        }
        .badge-green { background:var(--green-100); color:var(--green-600); }
        .badge-red { background:var(--red-100); color:var(--red-600); }
        .badge-amber { background:var(--amber-100); color:var(--amber-600); }
        .badge-blue { background:var(--blue-100); color:var(--blue-600); }
        .badge-purple { background:var(--purple-100); color:var(--purple-600); }
        .badge-pink { background:#fce7f3; color:#db2777; }
        .badge-teal { background:var(--teal-100); color:var(--teal-600); }
        .chevron {
            color: var(--slate-400);
            transition: transform .3s;
            font-size: .85rem;
            flex-shrink: 0;
            margin-left: 1rem;
        }
        .course-section.open .chevron { transform: rotate(180deg); }

        .course-body { display:none; border-top:1px solid var(--slate-200); }
        .course-section.open .course-body { display:block; }

        /* ── STATS ROW ── */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: .75rem;
            padding: 1rem 1.5rem;
            background: var(--slate-50);
            border-bottom: 1px solid var(--slate-200);
        }
        .stat-mini {
            text-align: center;
            padding: .5rem;
        }
        .stat-mini-val { font-size: 1.35rem; font-weight: 700; }
        .stat-mini-label { font-size: .72rem; color: var(--slate-500); font-weight: 500; }

        /* ── TABLE ── */
        .table-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: .75rem 1.5rem;
            border-bottom: 1px solid var(--slate-100);
        }
        .table-actions-left { display:flex; gap:.75rem; align-items:center; }
        .select-all-label {
            display:flex; align-items:center; gap:.4rem;
            font-size:.82rem; color:var(--slate-600); cursor:pointer; font-weight:500;
        }
        .select-all-label input { width:16px; height:16px; accent-color:var(--blue-600); cursor:pointer; }
        .table-wrapper { overflow-x: auto; }
        table { width:100%; border-collapse:collapse; font-size:.84rem; }
        thead { background: var(--slate-50); position:sticky; top:0; z-index:2; }
        th {
            padding: .7rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--slate-600);
            font-size: .76rem;
            text-transform: uppercase;
            letter-spacing: .04em;
            white-space: nowrap;
            border-bottom: 2px solid var(--slate-200);
            cursor: pointer;
            user-select: none;
            transition: color .2s;
        }
        th:hover { color: var(--blue-600); }
        th .sort-icon { margin-left:.3rem; font-size:.65rem; opacity:.4; }
        th.sorted .sort-icon { opacity:1; color:var(--blue-600); }
        td {
            padding: .65rem 1rem;
            border-bottom: 1px solid var(--slate-100);
            color: var(--slate-700);
            vertical-align: middle;
        }
        tr:hover td { background: var(--blue-50); }
        tr.selected td { background: rgba(37,99,235,.06); }
        td.cb-cell { width:36px; text-align:center; }
        td.cb-cell input { width:16px; height:16px; accent-color:var(--blue-600); cursor:pointer; }

        /* Progress bar */
        .progress-cell { min-width:130px; }
        .progress-bar-bg {
            width:100%; height:7px; background:var(--slate-100); border-radius:99px; overflow:hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,.06);
        }
        .progress-bar-fill { height:100%; border-radius:99px; transition: width .6s cubic-bezier(.34,1.56,.64,1); }
        .progress-text { font-size:.76rem; font-weight:700; margin-top:.2rem; font-family:'JetBrains Mono',monospace; }

        /* Time progress marker */
        .time-marker {
            position: absolute;
            top: -3px;
            bottom: -3px;
            width: 2px;
            background: var(--slate-700);
            border-radius: 2px;
            z-index: 1;
            cursor: help;
            transition: background .2s;
        }
        .time-marker::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            width: 6px;
            height: 6px;
            background: var(--slate-700);
            border-radius: 50%;
        }
        .time-marker:hover { background: var(--blue-600); }
        .time-marker:hover::before { background: var(--blue-600); }

        /* Status chips */
        .status { display:inline-flex; align-items:center; gap:.3rem; padding:.2rem .6rem; border-radius:999px; font-size:.73rem; font-weight:700; letter-spacing:.01em; }
        .status-a { background:var(--green-100); color:var(--green-600); box-shadow: 0 1px 3px rgba(22,163,74,.12); }
        .status-r { background:var(--red-100); color:var(--red-600); box-shadow: 0 1px 3px rgba(220,38,38,.12); }
        .status-p { background:var(--amber-100); color:var(--amber-600); box-shadow: 0 1px 3px rgba(217,119,6,.12); }

        .risk { display:inline-flex; padding:.2rem .6rem; border-radius:999px; font-size:.72rem; font-weight:700; }
        .risk-alto { background:var(--red-100); color:var(--red-600); box-shadow: 0 1px 3px rgba(220,38,38,.12); }
        .risk-medio { background:var(--amber-100); color:var(--amber-600); box-shadow: 0 1px 3px rgba(217,119,6,.12); }
        .risk-bajo { background:var(--green-50); color:var(--green-600); box-shadow: 0 1px 3px rgba(22,163,74,.08); }

        .sence-chip { display:inline-flex; align-items:center; gap:.25rem; font-size:.78rem; font-weight:600; }
        .sence-chip.connected { color: var(--green-600); }
        .sence-chip.disconnected { color: var(--slate-400); }
        .sence-num { font-family:'JetBrains Mono',monospace; }

        .grade { font-family:'JetBrains Mono',monospace; font-weight:700; font-size:.85rem; padding:.15rem .4rem; border-radius:4px; }
        .grade-pass { color: var(--green-600); background: var(--green-50); }
        .grade-fail { color: var(--red-600); background: var(--red-50); }
        .grade-na { color: var(--slate-400); }

        .email-cell { font-size:.78rem; color:var(--slate-500); max-width:180px; overflow:hidden; text-overflow:ellipsis; }
        .rut-cell { font-family:'JetBrains Mono',monospace; font-size:.78rem; color:var(--slate-600); white-space:nowrap; }

        /* Email icon tooltip */
        .email-icon-cell { width: 40px; }
        .email-tooltip-wrap { position: relative; display: inline-block; }
        .email-icon-btn {
            color: var(--slate-400);
            cursor: pointer;
            font-size: .85rem;
            transition: color .2s;
            padding: .35rem;
        }
        .email-icon-btn:hover { color: var(--blue-600); }
        .email-tooltip-box {
            display: none;
            position: absolute;
            bottom: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--slate-900);
            color: white;
            padding: .5rem .75rem;
            border-radius: 8px;
            font-size: .75rem;
            white-space: nowrap;
            z-index: 50;
            box-shadow: 0 8px 24px rgba(0,0,0,.2);
            align-items: center;
            gap: .5rem;
        }
        .email-tooltip-box::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--slate-900);
        }
        /* Invisible bridge between icon and tooltip to prevent gap */
        .email-tooltip-wrap::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            height: 10px;
            display: none;
        }
        .email-tooltip-wrap:hover .email-tooltip-box { display: flex; }
        .email-tooltip-wrap:hover::after { display: block; }
        .email-tooltip-box:hover { display: flex; }
        .email-tooltip-text { font-family: 'JetBrains Mono', monospace; }
        .email-copy-btn {
            background: rgba(255,255,255,.15);
            border: none;
            color: white;
            cursor: pointer;
            padding: .2rem .35rem;
            border-radius: 4px;
            font-size: .7rem;
            transition: background .2s;
        }
        .email-copy-btn:hover { background: rgba(255,255,255,.3); }

        /* Course ID link */
        .course-id-link {
            display: inline-flex;
            align-items: center;
            gap: .3rem;
            padding: .15rem .55rem;
            border-radius: 6px;
            font-size: .7rem;
            font-weight: 700;
            color: var(--blue-500);
            background: var(--blue-50);
            border: 1px solid var(--blue-100);
            text-decoration: none;
            transition: all .2s;
            flex-shrink: 0;
            font-family: 'JetBrains Mono', monospace;
        }
        .course-id-link:hover {
            background: var(--blue-100);
            color: var(--blue-700);
            box-shadow: 0 2px 8px rgba(37,99,235,.15);
        }
        .course-id-link i { font-size: .6rem; }

        /* Print button */
        .btn-print {
            background: rgba(139,92,246,.9);
            color: white;
            border: 1px solid rgba(124,58,237,.8);
        }
        .btn-print:hover {
            background: var(--purple-600);
            box-shadow: 0 4px 12px rgba(124,58,237,.3);
        }

        /* ── FLOATING BUTTON ── */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), var(--blue-500));
            color: white;
            border: none;
            box-shadow: 0 8px 24px rgba(37,99,235,.4);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            z-index: 100;
            transition: all .3s cubic-bezier(.34,1.56,.64,1);
        }
        .fab.visible { display:flex; animation: fabIn .4s cubic-bezier(.68,-.55,.265,1.55); }
        .fab:hover { transform:scale(1.1) translateY(-3px); box-shadow: 0 12px 32px rgba(37,99,235,.5); }
        .fab-count {
            position:absolute; top:-4px; right:-4px;
            width:24px; height:24px;
            background:var(--red-500);
            color:white;
            border-radius:50%;
            font-size:.72rem;
            font-weight:700;
            display:flex; align-items:center; justify-content:center;
            border: 3px solid white;
            box-shadow: var(--shadow);
        }
        @keyframes fabIn {
            0% { transform:scale(0); opacity:0; }
            60% { transform:scale(1.2); }
            100% { transform:scale(1); opacity:1; }
        }

        /* ── MODAL ── */
        .modal-overlay {
            position:fixed; inset:0; background:rgba(0,0,0,.5);
            backdrop-filter:blur(4px);
            z-index:200;
            display:none;
            align-items:center;
            justify-content:center;
            padding: 2rem;
        }
        .modal-overlay.open { display:flex; animation: fadeIn .2s; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        .modal {
            background:var(--white);
            border-radius:16px;
            width:100%;
            max-width:640px;
            max-height:90vh;
            overflow-y:auto;
            box-shadow: var(--shadow-xl);
        }
        .modal-head {
            padding:1.25rem 1.5rem;
            border-bottom:1px solid var(--slate-200);
            display:flex;
            justify-content:space-between;
            align-items:center;
        }
        .modal-head h2 { font-size:1.15rem; font-weight:700; }
        .modal-close {
            width:32px; height:32px; border-radius:50%;
            border:none; background:var(--slate-100);
            color:var(--slate-600);
            cursor:pointer;
            display:flex; align-items:center; justify-content:center;
            font-size:1.1rem;
            transition:all .2s;
        }
        .modal-close:hover { background:var(--slate-200); }
        .modal-body { padding:1.5rem; }
        .modal-footer {
            padding:1rem 1.5rem;
            border-top:1px solid var(--slate-200);
            display:flex;
            justify-content:flex-end;
            gap:.75rem;
        }
        .form-group { margin-bottom:1rem; }
        .form-label { display:block; font-size:.82rem; font-weight:600; color:var(--slate-700); margin-bottom:.35rem; }
        .form-control {
            width:100%;
            padding:.55rem .85rem;
            border:1px solid var(--slate-300);
            border-radius:var(--radius-xs);
            font-size:.88rem;
            font-family:inherit;
            color:var(--slate-700);
        }
        .form-control:focus { outline:none; border-color:var(--blue-500); box-shadow:0 0 0 3px rgba(59,130,246,.12); }
        textarea.form-control { resize:vertical; min-height:120px; }
        .selected-students-list {
            max-height:160px; overflow-y:auto;
            border:1px solid var(--slate-200);
            border-radius:var(--radius-xs);
            padding:.5rem;
        }
        .sel-student {
            display:flex; justify-content:space-between; align-items:center;
            padding:.35rem .5rem;
            border-radius:var(--radius-xs);
            font-size:.82rem;
        }
        .sel-student:nth-child(even) { background:var(--slate-50); }
        .sel-student-name { font-weight:600; color:var(--slate-800); }
        .sel-student-email { color:var(--slate-500); font-size:.78rem; }
        .sel-student-course { color:var(--blue-600); font-size:.72rem; font-weight:500; }
        .btn {
            padding:.55rem 1.25rem;
            border-radius:var(--radius-xs);
            font-size:.88rem;
            font-weight:600;
            font-family:inherit;
            cursor:pointer;
            border:none;
            display:inline-flex;
            align-items:center;
            gap:.4rem;
            transition:all .2s;
        }
        .btn-primary { background:var(--blue-600); color:white; }
        .btn-primary:hover { background:var(--blue-500); box-shadow:0 4px 12px rgba(37,99,235,.3); }
        .btn-secondary { background:var(--white); color:var(--slate-700); border:1px solid var(--slate-300); }
        .btn-secondary:hover { background:var(--slate-50); }
        .email-preview {
            background:var(--slate-50);
            border:1px solid var(--slate-200);
            border-radius:var(--radius-xs);
            padding:1rem;
            font-size:.85rem;
            color:var(--slate-600);
            white-space:pre-wrap;
            line-height:1.6;
        }

        /* ── RESPONSIVE ── */
        @media (max-width: 1200px) {
            .header-inner {
                flex-direction: column;
                align-items: stretch;
                gap: 1.5rem;
            }
            .header-left {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            .header-right {
                align-items: center;
            }
            .header-info {
                flex-direction: column;
                width: 100%;
            }
            .info-box {
                width: 100%;
            }
            .header-actions {
                justify-content: center;
                width: 100%;
            }
            .header-actions-row {
                justify-content: center;
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .app { padding:.75rem; }
            .header { padding:1.25rem; }
            .header-inner { gap: 1rem; }
            .header-left { gap: 1rem; }
            .logo-box {
                width: 170px;
                height: 50px;
            }
            .header-text h1 { font-size:1.2rem; }
            .header-text p { font-size: .8rem; }
            .info-box {
                padding: .5rem .75rem;
                font-size: .75rem;
            }
            .btn-action {
                padding: .45rem .85rem;
                font-size: .8rem;
            }
            .kpi-grid { grid-template-columns: repeat(2,1fr); gap:.75rem; }
            .charts-row { grid-template-columns: 1fr !important; }
            .filters-bar { flex-direction:column; align-items:stretch; }
            .filter-input { width:100%; }
            .course-meta { display:none; }
        }

        /* ── CHARTS ROW ── */
        .charts-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .chart-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow), 0 0 0 1px rgba(0,0,0,.03);
            overflow: hidden;
        }
        .chart-card-header {
            padding: .85rem 1.25rem;
            border-bottom: 1px solid var(--slate-100);
        }
        .chart-card-header h3 {
            font-size: .82rem;
            font-weight: 700;
            color: var(--slate-700);
            display: flex;
            align-items: center;
            gap: .5rem;
        }
        .chart-card-header h3 i {
            color: var(--blue-500);
            font-size: .75rem;
        }
        .chart-card-body {
            padding: 1rem 1.25rem;
        }
        @media (max-width: 1024px) {
            .charts-row { grid-template-columns: 1fr; }
        }

        /* ── TOAST NOTIFICATION ── */
        .toast {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            padding: .85rem 1.5rem;
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 600;
            font-size: .88rem;
            z-index: 300;
            box-shadow: var(--shadow-lg);
            transform: translateY(20px);
            opacity: 0;
            transition: all .3s ease;
            max-width: 400px;
        }
        .toast.visible { transform: translateY(0); opacity: 1; }
        .toast-success { background: var(--green-600); }
        .toast-error { background: var(--red-600); }
        .toast-info {
            background: linear-gradient(135deg, #1e3a5f 0%, #1d4ed8 100%);
            border-left: 4px solid #60a5fa;
            max-width: 480px;
            font-size: .9rem;
            line-height: 1.5;
        }

        /* ── LOADING STATE ── */
        .loading-container {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--slate-500);
        }
        .loading-spinner {
            width: 48px; height: 48px;
            border: 4px solid var(--slate-200);
            border-top-color: var(--blue-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ── UTILITY ── */
        .hidden { display:none !important; }
        .text-center { text-align:center; }
        .mono { font-family:'JetBrains Mono',monospace; }

        /* ── STAGGER ANIMATION ── */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .kpi-card { animation: fadeUp .5s ease both; }
        .kpi-card:nth-child(1) { animation-delay: .05s; }
        .kpi-card:nth-child(2) { animation-delay: .1s; }
        .kpi-card:nth-child(3) { animation-delay: .15s; }
        .kpi-card:nth-child(4) { animation-delay: .2s; }
        .kpi-card:nth-child(5) { animation-delay: .25s; }
        .kpi-card:nth-child(6) { animation-delay: .3s; }
        .kpi-card:nth-child(7) { animation-delay: .35s; }
        .kpi-card:nth-child(8) { animation-delay: .4s; }
        .chart-card { animation: fadeUp .5s ease both; }
        .chart-card:nth-child(1) { animation-delay: .45s; }
        .chart-card:nth-child(2) { animation-delay: .5s; }
        .chart-card:nth-child(3) { animation-delay: .55s; }

        /* ── PRINT STYLES ── */
        @media print {
            @page {
                size: letter landscape;
                margin: 1.5cm 1cm 1.5cm 1cm;
            }
            body {
                background: white !important;
                font-size: 9pt !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .app { max-width: 100% !important; padding: 0 !important; }
            .header { border-radius: 0 !important; margin-bottom: .5rem !important; padding: 1rem 1.5rem !important; box-shadow: none !important; page-break-after: avoid; }
            .header::before, .header::after { display: none !important; }
            .header-right { display: none !important; }
            .kpi-grid { grid-template-columns: repeat(8, 1fr) !important; gap: .4rem !important; margin-bottom: .5rem !important; }
            .kpi-card { padding: .5rem .6rem !important; box-shadow: none !important; border: 1px solid #ddd !important; border-radius: 6px !important; animation: none !important; }
            .kpi-card::before { display: none !important; }
            .kpi-value { font-size: 1.2rem !important; }
            .kpi-label { font-size: .55rem !important; }
            .kpi-sub { display: none !important; }
            .charts-row { display: none !important; }
            .filters-bar { display: none !important; }
            .course-section { box-shadow: none !important; border: 1px solid #ddd !important; margin-bottom: .4rem !important; page-break-inside: avoid; }
            .course-section .course-body { display: block !important; }
            .course-header { padding: .5rem 1rem !important; }
            .course-badges { display: none !important; }
            .chevron { display: none !important; }
            .course-checkbox { display: none !important; }
            .stats-row { padding: .4rem 1rem !important; gap: .3rem !important; }
            .stat-mini-val { font-size: 1rem !important; }
            .stat-mini-label { font-size: .55rem !important; }
            .table-actions { display: none !important; }
            table { font-size: 7.5pt !important; }
            th { padding: .3rem .4rem !important; font-size: .55rem !important; }
            td { padding: .25rem .4rem !important; }
            .progress-cell { min-width: 80px !important; }
            .progress-bar-bg { height: 4px !important; }
            .time-marker { top: -2px !important; bottom: -2px !important; }
            .email-tooltip-box { display: none !important; }
            .email-icon-btn { display: none !important; }
            .email-icon-cell::after { content: attr(data-email); font-size: 6pt; color: #666; }
            .fab { display: none !important; }
            .modal-overlay { display: none !important; }
            .toast { display: none !important; }
            .course-id-link { color: var(--blue-600) !important; background: none !important; border: none !important; padding: 0 !important; font-size: .6rem !important; }
            /* Watermark */
            .print-watermark {
                display: block !important;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-35deg);
                font-size: 2.5rem;
                font-weight: 800;
                color: rgba(0,0,0,.04);
                white-space: nowrap;
                pointer-events: none;
                z-index: 0;
                letter-spacing: .08em;
            }
        }
        .print-watermark { display: none; }
    </style>
</head>
<body>
<div class="app" id="app">
    <!-- HEADER -->
    <header class="header">
        <div class="header-inner">
            <!-- Left Section: Logo + Title -->
            <div class="header-left">
                <div class="logo-box">
                    <div>
                        <div style="font-weight:500; font-size:.58rem; letter-spacing:.12em; text-transform:uppercase; color:var(--slate-500); margin-bottom:1px;">Instituto de Capacitación</div>
                        <div style="font-weight:800; font-size:1.05rem; letter-spacing:.04em; color:var(--slate-900); line-height:1.1;">TECNIPRO</div>
                    </div>
                </div>
                <div class="header-text">
                    <h1>Sistema de Gestión de Capacitación</h1>
                    <p>Panel de Control · Monitoreo de Cursos en Tiempo Real</p>
                </div>
            </div>

            <!-- Right Section: User Info + Date/Time + Actions -->
            <div class="header-right">
                <!-- Info Cards Row -->
                <div class="header-info">
                    <!-- User Info Box -->
                    <div class="info-box" id="userInfoBox" style="display:none;">
                        <div class="info-box-row">
                            <i class="fas fa-user"></i>
                            <strong id="userName"></strong>
                            <span class="user-role-badge" id="userRoleBadge"></span>
                        </div>
                    </div>

                    <!-- Date/Time Info Box -->
                    <div class="info-box">
                        <div class="info-box-row">
                            <i class="fas fa-calendar"></i>
                            <span id="currentDate"></span>
                        </div>
                        <div class="info-box-row">
                            <i class="fas fa-clock"></i>
                            <span id="currentTime"></span>
                        </div>
                    </div>

                    <!-- Data Update Info Box -->
                    <div class="info-box">
                        <div class="info-box-row">
                            <i class="fas fa-graduation-cap" style="color:#3b82f6;"></i>
                            <span style="font-size:.78rem;">Plataforma: <strong id="dateDateMoodle">—</strong></span>
                        </div>
                        <div class="info-box-row">
                            <i class="fas fa-id-card" style="color:#10b981;"></i>
                            <span style="font-size:.78rem;">SENCE: <strong id="dateDateSence">—</strong></span>
                        </div>
                        <div class="info-box-row" id="dataAgeWarning" style="display:none;">
                            <span class="data-age-warning" id="dataAgeText"></span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons Row -->
                <div class="header-actions" id="headerActions" style="display:none;">
                    <!-- FILA 1: Acciones de datos (admin: 3, comprador: 1) -->
                    <div class="header-actions-row header-actions-main">
                        <button class="btn-action btn-refresh" id="btnRefresh" onclick="refreshMoodleData()" style="display:none;" title="Actualiza datos de todos los cursos desde Moodle">
                            <i class="fas fa-sync-alt"></i> Actualizar Datos
                        </button>
                        <button class="btn-action btn-refresh-select" id="btnRefreshSelect" onclick="abrirModalRefreshCursos()" style="display:none;" title="Elige uno o más cursos específicos para actualizar">
                            <i class="fas fa-filter"></i> Cursos Elegidos
                        </button>
                        <button class="btn-action btn-refresh-full" id="btnRefreshFull" onclick="refreshFullData()" style="display:none;" title="Ejecuta actualización completa: datos de cursos + SENCE (5-30 minutos)">
                            <i class="fas fa-cloud-download-alt"></i> Actualización Completa
                        </button>
                        <button class="btn-action btn-coordinadores" id="btnCoordinadores" onclick="abrirModalCoordinadores()" style="display:none;" title="Gestionar coordinadores de clientes por curso">
                            <i class="fas fa-users-cog"></i> Gestionar Coordinadores
                        </button>
                    </div>

                    <!-- FILA 2: Navegación + Print -->
                    <div class="header-actions-row header-actions-nav">
                        <button class="btn-action btn-print" id="btnPrint" onclick="printReport()" style="display:none;">
                            <i class="fas fa-file-pdf"></i> Imprimir PDF
                        </button>
                        <a href="/hub" class="btn-action btn-back" id="btnVolverHub" style="display:none;">
                            <i class="fas fa-th-large"></i> Volver al Menu
                        </a>
                        <a href="https://www.tecnipro.cl" class="btn-action btn-back" id="btnVolverTecnipro">
                            <i class="fas fa-arrow-left"></i> Volver a Tecnipro
                        </a>
                        <a href="/logout" class="btn-action btn-logout">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                        </a>
                    </div>
                    <!-- Cancelar: fuera de las filas, solo aparece durante actualización -->
                    <div style="text-align:center;">
                        <button class="btn-action btn-cancel" id="btnCancelRefresh" onclick="cancelFullRefresh()" style="display:none;" title="Cancelar actualización en progreso">
                            <i class="fas fa-times-circle"></i> Cancelar Actualización
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- KPIs -->
    <div class="kpi-grid" id="kpiGrid"></div>

    <!-- CHARTS -->
    <div class="charts-row" id="chartsRow" style="display:none;">
        <div class="chart-card">
            <div class="chart-card-header">
                <h3><i class="fas fa-chart-pie"></i> Estado de Participantes</h3>
            </div>
            <div class="chart-card-body">
                <canvas id="chartEstados" height="220"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-card-header">
                <h3><i class="fas fa-chart-bar"></i> Progreso por Curso</h3>
            </div>
            <div class="chart-card-body">
                <canvas id="chartProgreso" height="220"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-card-header">
                <h3><i class="fas fa-bolt"></i> Nivel de Riesgo</h3>
            </div>
            <div class="chart-card-body">
                <canvas id="chartRiesgo" height="220"></canvas>
            </div>
        </div>
    </div>

    <!-- FILTERS -->
    <div class="filters-bar">
        <div class="filter-group">
            <label><i class="fas fa-filter"></i> Curso:</label>
            <select class="filter-select" id="filterCourse">
                <option value="">Todos los cursos</option>
            </select>
        </div>
        <div class="filter-group">
            <label><i class="fas fa-tags"></i> Categoría:</label>
            <select class="filter-select" id="filterCategory">
                <option value="">Todas</option>
            </select>
        </div>
        <div class="filter-group">
            <label><i class="fas fa-flag"></i> Estado:</label>
            <select class="filter-select" id="filterStatus">
                <option value="">Todos</option>
                <option value="A">Aprobados</option>
                <option value="R">Reprobados</option>
                <option value="P">En proceso</option>
            </select>
        </div>
        <div class="filter-group">
            <label><i class="fas fa-exclamation-triangle"></i> Riesgo:</label>
            <select class="filter-select" id="filterRisk">
                <option value="">Todos</option>
                <option value="alto">Alto</option>
                <option value="medio">Medio</option>
                <option value="bajo">Bajo</option>
            </select>
        </div>
        <div class="filter-group" style="flex:1;">
            <label><i class="fas fa-search"></i></label>
            <input type="text" class="filter-input" id="filterSearch" placeholder="Buscar participante, RUT, correo...">
        </div>
        <button class="btn-clear" onclick="clearFilters()"><i class="fas fa-times"></i> Limpiar</button>
        <button class="btn-action btn-excel" onclick="descargarTodo()" id="btnExcelTodo">
            <i class="fas fa-file-excel"></i> Descargar Todo
        </button>
        <button class="btn-action btn-excel-secondary" onclick="descargarSeleccion()" id="btnExcelSeleccion" disabled title="Seleccione al menos un curso">
            <i class="fas fa-file-excel"></i> Descargar Selección (<span id="selectedCount">0</span>)
        </button>
    </div>

    <!-- COURSES -->
    <div id="courseSections"></div>

    <!-- FAB -->
    <button class="fab" id="fabEmail" onclick="openEmailModal()">
        <i class="fas fa-envelope"></i>
        <span class="fab-count" id="fabCount">0</span>
    </button>

    <!-- EMAIL MODAL -->
    <div class="modal-overlay" id="emailModalOverlay">
        <div class="modal">
            <div class="modal-head">
                <h2><i class="fas fa-paper-plane" style="color:var(--blue-600);margin-right:.5rem;"></i> Enviar Correo a Seleccionados</h2>
                <button class="modal-close" onclick="closeEmailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Participantes seleccionados (<span id="modalCount">0</span>)</label>
                    <div class="selected-students-list" id="selectedList"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Asunto</label>
                    <input type="text" class="form-control" id="emailSubject" value="Información sobre tu curso de capacitación - Instituto Tecnipro">
                </div>
                <div class="form-group">
                    <label class="form-label">Mensaje</label>
                    <textarea class="form-control" id="emailBody">Estimado/a participante,

Le escribimos para informarle sobre el estado de su curso de capacitación.

[Personalizar mensaje aquí]

Saludos cordiales,
Instituto de Capacitación Tecnipro
www.institutotecnipro.cl</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Vista previa</label>
                    <div class="email-preview" id="emailPreview"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEmailModal()">Cancelar</button>
                <button class="btn btn-primary" id="btnSendEmail" onclick="sendEmails()">
                    <i class="fas fa-paper-plane"></i> Enviar Correo
                </button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!-- PRINT WATERMARK -->
    <div class="print-watermark">INSTITUTO DE CAPACITACIÓN TECNIPRO</div>
</div>

<script>
// ═══════════════════════════════════════════════════════
// CSRF — include token in all POST/PUT/DELETE requests
// ═══════════════════════════════════════════════════════
const CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]')?.content || '';
const _originalFetch = window.fetch;
window.fetch = function(url, options = {}) {
    if (options.method && options.method !== 'GET') {
        options.headers = Object.assign({}, options.headers, {'X-CSRFToken': CSRF_TOKEN});
    }
    return _originalFetch(url, options);
};

// ═══════════════════════════════════════════════════════
// DATA — loaded dynamically from /api/datos
// ═══════════════════════════════════════════════════════
let DATA = null;
let CURRENT_USER = null; // loaded from /api/me

// ═══════════════════════════════════════════════════════
// FIELD MAPPING: real JSON → dashboard field names
// ═══════════════════════════════════════════════════════
function normalizeData(raw) {
    // Normalize student fields from real JSON to dashboard conventions
    if (!raw || !raw.cursos) return raw;
    for (const curso of raw.cursos) {
        if (!curso.estudiantes) continue;
        for (const est of curso.estudiantes) {
            // id → rut
            if (est.id && !est.rut) est.rut = est.id;
            // dias_sin_ingreso → dias_sin_acceso
            if (est.dias_sin_ingreso !== undefined && est.dias_sin_acceso === undefined)
                est.dias_sin_acceso = est.dias_sin_ingreso;
            // riesgo: empty string → ""
            if (!est.riesgo) est.riesgo = "";
            // sence normalization
            if (est.sence) {
                // declaracion_jurada → estado_dj
                if (est.sence.declaracion_jurada !== undefined && est.sence.estado_dj === undefined) {
                    est.sence.estado_dj = est.sence.declaracion_jurada || null;
                }
            }
        }
    }
    return raw;
}

// ═══════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════
const selectedStudents = new Map(); // key: rut+courseId, value: {student, courseName}
let sortState = {}; // courseId -> { field, asc }

// ═══════════════════════════════════════════════════════
// INIT — load data from API
// ═══════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', async () => {
    updateClock();
    setInterval(updateClock, 60000);
    await loadUserInfo();
    loadData();
});

async function loadUserInfo() {
    try {
        const resp = await fetch('/api/me');
        if (resp.ok) {
            CURRENT_USER = await resp.json();
            document.getElementById('userName').textContent = CURRENT_USER.nombre;
            document.getElementById('userRoleBadge').textContent =
                CURRENT_USER.rol === 'admin' ? 'Admin' : 'Comprador';
            document.getElementById('userInfoBox').style.display = '';
            document.getElementById('headerActions').style.display = 'flex';

            // Hide email controls for non-admin
            if (CURRENT_USER.rol !== 'admin') {
                document.getElementById('fabEmail').style.display = 'none';
                document.getElementById('emailModalOverlay').style.display = 'none';
            }

            // ── Distribución de botones según rol ──
            // SUPERADMIN: Fila 1 (Actualizar, Act.Completa, Coordinadores) + Fila 2 (Imprimir, Volver, Cerrar) = 3+3
            // ADMIN: Fila 1 (Actualizar, Coordinadores) + Fila 2 (Imprimir, Volver, Cerrar) = 2+3
            // COMPRADOR: Fila 1 (Actualizar) + Fila 2 (Imprimir, Volver, Cerrar) = 1+3

            const SUPERADMINS = ['ygonzalez@duocapital.cl', 'jortizleiva@duocapital.cl'];
            const row1 = document.querySelector('.header-actions-main');
            const row2 = document.querySelector('.header-actions-nav');
            const btnPrint = document.getElementById('btnPrint');
            const btnRefresh = document.getElementById('btnRefresh');

            // Mostrar botones comunes
            btnRefresh.style.display = '';
            btnPrint.style.display = '';

            if (CURRENT_USER.rol === 'admin') {
                // ADMIN: Actualizar, Cursos Elegidos, Act.Completa, Coordinadores | Imprimir, Volver al Menu, Cerrar
                document.getElementById('btnRefreshSelect').style.display = '';
                document.getElementById('btnCoordinadores').style.display = '';
                document.getElementById('btnVolverHub').style.display = '';

                if (SUPERADMINS.includes(CURRENT_USER.email)) {
                    document.getElementById('btnRefreshFull').style.display = '';
                }
            } else {
                // COORDINADOR 2+2: Actualizar, Imprimir | Volver, Cerrar
                // Move Print to row 1
                row1.appendChild(btnPrint);
            }
        }
    } catch (e) {
        // If /api/me fails, user info section stays hidden
    }
}

async function loadData() {
    const container = document.getElementById('courseSections');
    const isAdmin = CURRENT_USER && CURRENT_USER.rol === 'admin';

    // ── Animated loading messages ──
    const loadingSteps = [
        { icon: 'fa-satellite-dish', text: 'Conectando con el servidor...', sub: 'Estableciendo conexión con la plataforma' },
        { icon: 'fa-users', text: 'Obteniendo participantes...', sub: 'Descargando matrículas y datos de estudiantes' },
        { icon: 'fa-tasks', text: 'Calculando progreso...', sub: 'Revisando actividades completadas por cada estudiante' },
        { icon: 'fa-star-half-alt', text: 'Procesando evaluaciones...', sub: 'Extrayendo notas y promedios de cada curso' },
        { icon: 'fa-chart-pie', text: 'Generando estadísticas...', sub: 'Cruzando datos y calculando indicadores' },
        { icon: 'fa-magic', text: 'Casi listo...', sub: 'Preparando tu dashboard personalizado' },
    ];

    let stepIndex = 0;

    function renderLoadingStep() {
        const step = loadingSteps[stepIndex % loadingSteps.length];
        const progress = Math.min(((stepIndex + 1) / loadingSteps.length) * 100, 95);
        container.innerHTML = `
            <div class="loading-container" style="padding:5rem 2rem;">
                <div style="position:relative;width:72px;height:72px;margin:0 auto 2rem;">
                    <div class="loading-spinner" style="width:72px;height:72px;border-width:5px;"></div>
                    <i class="fas ${step.icon}" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.5rem;color:var(--blue-600);"></i>
                </div>
                <p style="font-size:1.2rem;font-weight:700;color:var(--slate-800);margin-bottom:.35rem;">
                    ${step.text}
                </p>
                <p style="font-size:.85rem;color:var(--slate-500);margin-bottom:1.5rem;">
                    ${step.sub}
                </p>
                <div style="max-width:320px;margin:0 auto;height:6px;background:var(--slate-200);border-radius:99px;overflow:hidden;">
                    <div style="height:100%;width:${progress}%;background:linear-gradient(90deg,var(--blue-600),var(--teal-500));border-radius:99px;transition:width .8s ease;"></div>
                </div>
                <p style="font-size:.72rem;color:var(--slate-400);margin-top:.75rem;font-family:'JetBrains Mono',monospace;">
                    Paso ${Math.min(stepIndex + 1, loadingSteps.length)} de ${loadingSteps.length}
                </p>
            </div>`;
    }

    renderLoadingStep();
    const stepInterval = setInterval(() => {
        stepIndex++;
        if (stepIndex < loadingSteps.length) renderLoadingStep();
    }, 5000);

    try {
        // Cargar datos procesados (caché). El refresh se hace solo via botón "Actualizar Datos".
        const response = await fetch('/api/datos');
        clearInterval(stepInterval);

        if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            throw new Error(err.error || `HTTP ${response.status}`);
        }

        // Show final step
        container.innerHTML = `
            <div class="loading-container" style="padding:5rem 2rem;">
                <i class="fas fa-check-circle" style="font-size:3rem;color:var(--green-500);margin-bottom:1rem;"></i>
                <p style="font-size:1.2rem;font-weight:700;color:var(--green-600);">¡Datos cargados!</p>
            </div>`;

        DATA = normalizeData(await response.json());
        // Mostrar fechas de última actualización Moodle y SENCE
        function _fmtFecha(iso) {
            if (!iso) return '—';
            const d = new Date(iso);
            if (isNaN(d)) return '—';
            return d.toLocaleDateString('es-CL') + ' ' +
                   d.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });
        }
        if (DATA.metadata) {
            document.getElementById('dateDateMoodle').textContent =
                _fmtFecha(DATA.metadata.fecha_moodle || DATA.metadata.fecha_procesamiento);
            document.getElementById('dateDateSence').textContent =
                _fmtFecha(DATA.metadata.fecha_sence);
        }

        // Brief pause to show success, then render
        await new Promise(r => setTimeout(r, 600));

        populateFilters();
        renderKPIs();
        renderCourses();
        renderCharts();
        setupFilterListeners();
        checkDataAge();
    } catch (error) {
        clearInterval(stepInterval);
        document.getElementById('kpiGrid').innerHTML = '';
        container.innerHTML = `
            <div style="text-align:center;padding:4rem;background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);">
                <i class="fas fa-exclamation-triangle" style="font-size:3rem;color:var(--amber-500);margin-bottom:1rem;"></i>
                <h2 style="margin-bottom:.5rem;">Error al cargar datos</h2>
                <p style="color:var(--slate-500);">No se pudo conectar con el servidor. Verifique que el pipeline se ejecutó correctamente.</p>
                <p style="color:var(--red-500);margin-top:.75rem;font-family:'JetBrains Mono',monospace;font-size:.85rem;">${error.message}</p>
                <button class="btn btn-primary" style="margin-top:1.5rem;" onclick="loadData()">
                    <i class="fas fa-redo"></i> Reintentar
                </button>
            </div>`;
    }
}

function updateClock() {
    const now = new Date();
    document.getElementById('currentDate').textContent = now.toLocaleDateString('es-CL',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    document.getElementById('currentTime').textContent = now.toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'});
}

// ═══════════════════════════════════════════════════════
// KPIs
// ═══════════════════════════════════════════════════════
function renderKPIs(filteredStudents) {
    const all = filteredStudents || DATA.cursos.flatMap(c => c.estudiantes);
    const totalStudents = all.length;
    const approved = all.filter(s => s.estado === 'A').length;
    const failed = all.filter(s => s.estado === 'R').length;
    const inProcess = all.filter(s => s.estado === 'P').length;
    const highRisk = all.filter(s => s.riesgo === 'alto').length;
    const avgProgress = totalStudents ? (all.reduce((s,e)=>s+e.progreso,0)/totalStudents).toFixed(1) : 0;
    const connected = all.filter(s => s.sence && s.sence.n_ingresos > 0).length;

    // Count visible courses
    const visibleCourses = filteredStudents
        ? document.querySelectorAll('.course-section:not([style*="display: none"])').length
        : DATA.cursos.length;

    const kpis = [
        { label:'Cursos', value: visibleCourses, cls:'blue', sub:'visibles', icon:'fa-book' },
        { label:'Participantes', value: totalStudents, cls:'blue', sub:`en ${visibleCourses} cursos`, icon:'fa-users' },
        { label:'Aprobados', value: approved, cls:'green', sub:`${totalStudents?((approved/totalStudents)*100).toFixed(0):0}% del total`, icon:'fa-check-circle' },
        { label:'Reprobados', value: failed, cls:'red', sub:`${totalStudents?((failed/totalStudents)*100).toFixed(0):0}% del total`, icon:'fa-times-circle' },
        { label:'En Proceso', value: inProcess, cls:'amber', sub:`${totalStudents?((inProcess/totalStudents)*100).toFixed(0):0}% del total`, icon:'fa-clock' },
        { label:'Riesgo Alto', value: highRisk, cls:'red', sub:'requieren atención', icon:'fa-exclamation-triangle' },
        { label:'Progreso Prom.', value: avgProgress+'%', cls:'teal', sub:'promedio general', icon:'fa-chart-line' },
        { label:'Conectados SENCE', value: connected, cls:'purple', sub:`de ${totalStudents} participantes`, icon:'fa-plug' },
    ];

    document.getElementById('kpiGrid').innerHTML = kpis.map(k => `
        <div class="kpi-card">
            <div class="kpi-label"><i class="fas ${k.icon}" style="margin-right:.3rem;"></i> ${k.label}</div>
            <div class="kpi-value ${k.cls}">${k.value}</div>
            <div class="kpi-sub">${k.sub}</div>
        </div>
    `).join('');
}

// ═══════════════════════════════════════════════════════
// CHARTS
// ═══════════════════════════════════════════════════════
let chartEstados = null, chartProgreso = null, chartRiesgo = null;

function renderCharts() {
    if (!DATA || !DATA.cursos || DATA.cursos.length === 0) return;
    document.getElementById('chartsRow').style.display = 'grid';

    const allStudents = DATA.cursos.flatMap(c => c.estudiantes);
    const approved = allStudents.filter(s => s.estado === 'A').length;
    const failed = allStudents.filter(s => s.estado === 'R').length;
    const inProcess = allStudents.filter(s => s.estado === 'P').length;

    // Chart defaults
    Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";
    Chart.defaults.font.size = 12;

    // ── Donut: Estados ──
    if (chartEstados) chartEstados.destroy();
    chartEstados = new Chart(document.getElementById('chartEstados'), {
        type: 'doughnut',
        data: {
            labels: ['Aprobados', 'Reprobados', 'En Proceso'],
            datasets: [{
                data: [approved, failed, inProcess],
                backgroundColor: ['#22c55e', '#ef4444', '#f59e0b'],
                borderWidth: 0,
                spacing: 3,
                borderRadius: 6,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { padding: 16, usePointStyle: true, pointStyleWidth: 10, font: { size: 11, weight: '600' } }
                }
            }
        }
    });

    // ── Bar: Progreso por Curso ──
    const cursoLabels = DATA.cursos.map(c => c.nombre.length > 25 ? c.nombre.substring(0, 25) + '…' : c.nombre);
    const progresoData = DATA.cursos.map(c => c.estadisticas.promedio_progreso);
    const barColors = progresoData.map(p => p >= 80 ? '#22c55e' : p >= 50 ? '#f59e0b' : '#ef4444');

    if (chartProgreso) chartProgreso.destroy();
    chartProgreso = new Chart(document.getElementById('chartProgreso'), {
        type: 'bar',
        data: {
            labels: cursoLabels,
            datasets: [{
                label: 'Progreso Promedio %',
                data: progresoData,
                backgroundColor: barColors,
                borderRadius: 6,
                borderSkipped: false,
                barThickness: DATA.cursos.length > 6 ? 'flex' : 32,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: DATA.cursos.length > 4 ? 'y' : 'x',
            scales: {
                x: {
                    grid: { display: DATA.cursos.length > 4, color: 'rgba(0,0,0,.04)' },
                    max: DATA.cursos.length > 4 ? 100 : undefined,
                    ticks: { font: { size: 10, weight: '500' } }
                },
                y: {
                    grid: { display: DATA.cursos.length <= 4, color: 'rgba(0,0,0,.04)' },
                    max: DATA.cursos.length <= 4 ? 100 : undefined,
                    ticks: { font: { size: 10 } }
                },
            },
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: (ctx) => ` ${ctx.parsed.x || ctx.parsed.y}%` } }
            }
        }
    });

    // ── Donut: Riesgo ──
    const rAlto = allStudents.filter(s => s.riesgo === 'alto').length;
    const rMedio = allStudents.filter(s => s.riesgo === 'medio').length;
    const rBajo = allStudents.filter(s => s.riesgo === 'bajo').length;
    const rNone = allStudents.filter(s => !s.riesgo).length;

    if (chartRiesgo) chartRiesgo.destroy();
    chartRiesgo = new Chart(document.getElementById('chartRiesgo'), {
        type: 'doughnut',
        data: {
            labels: ['Alto', 'Medio', 'Bajo', 'Sin riesgo'],
            datasets: [{
                data: [rAlto, rMedio, rBajo, rNone],
                backgroundColor: ['#ef4444', '#f59e0b', '#22c55e', '#cbd5e1'],
                borderWidth: 0,
                spacing: 3,
                borderRadius: 6,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { padding: 16, usePointStyle: true, pointStyleWidth: 10, font: { size: 11, weight: '600' } }
                }
            }
        }
    });
}

// ═══════════════════════════════════════════════════════
// FILTERS
// ═══════════════════════════════════════════════════════
function populateFilters() {
    const courseSelect = document.getElementById('filterCourse');
    const catSelect = document.getElementById('filterCategory');
    const categories = [...new Set(DATA.cursos.map(c=>c.categoria))];

    DATA.cursos.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id_moodle;
        opt.textContent = c.nombre;
        courseSelect.appendChild(opt);
    });
    categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        catSelect.appendChild(opt);
    });
}

function setupFilterListeners() {
    ['filterCourse','filterCategory','filterStatus','filterRisk'].forEach(id => {
        document.getElementById(id).addEventListener('change', applyFilters);
    });
    document.getElementById('filterSearch').addEventListener('input', applyFilters);
}

function clearFilters() {
    document.getElementById('filterCourse').value = '';
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterRisk').value = '';
    document.getElementById('filterSearch').value = '';
    applyFilters();
    renderKPIs(); // Reset to all students
}

function applyFilters() {
    const courseFilter = document.getElementById('filterCourse').value;
    const catFilter = document.getElementById('filterCategory').value;
    const statusFilter = document.getElementById('filterStatus').value;
    const riskFilter = document.getElementById('filterRisk').value;
    const search = document.getElementById('filterSearch').value.toLowerCase().trim();

    const visibleStudents = [];

    document.querySelectorAll('.course-section').forEach(section => {
        const cid = section.dataset.courseId;
        const course = DATA.cursos.find(c => c.id_moodle === cid);
        if (!course) return;

        // Course-level filters
        let showCourse = true;
        if (courseFilter && cid !== courseFilter) showCourse = false;
        if (catFilter && course.categoria !== catFilter) showCourse = false;

        section.style.display = showCourse ? '' : 'none';
        if (!showCourse) return;

        // Student-level filters
        const rows = section.querySelectorAll('tbody tr');
        let visibleCount = 0;
        rows.forEach(row => {
            const studentIdx = parseInt(row.dataset.studentIdx);
            const student = course.estudiantes[studentIdx];
            if (!student) return;

            let show = true;
            if (statusFilter && student.estado !== statusFilter) show = false;
            if (riskFilter && student.riesgo !== riskFilter) show = false;
            if (search) {
                const haystack = `${student.nombre} ${student.rut||student.id||''} ${student.email}`.toLowerCase();
                if (!haystack.includes(search)) show = false;
            }
            row.style.display = show ? '' : 'none';
            if (show) {
                visibleCount++;
                visibleStudents.push(student);
            }
        });

        // Show section count
        const countEl = section.querySelector('.student-count-display');
        if (countEl) countEl.textContent = visibleCount;
    });

    // Update KPIs with visible students only
    renderKPIs(visibleStudents);
}

// ═══════════════════════════════════════════════════════
// RENDER COURSES
// ═══════════════════════════════════════════════════════
function renderCourses() {
    const container = document.getElementById('courseSections');
    container.innerHTML = DATA.cursos.map((course, ci) => {
        const stats = course.estadisticas;
        const indicator = course.dias_restantes < 0 ? 'ci-finished' :
                         course.dias_restantes <= 7 ? 'ci-danger' :
                         course.dias_restantes <= 30 ? 'ci-warning' : 'ci-active';

        const daysLabel = course.dias_restantes < 0
            ? `Vencido hace ${Math.abs(course.dias_restantes)} días`
            : `${course.dias_restantes} días restantes`;

        // Determine modalidad badge color
        const modalidadBadgeClass = course.modalidad === 'Asincrónico' ? 'badge-teal' :
                                     course.modalidad === 'Sincrónico' ? 'badge-pink' : 'badge-blue';

        // Calculate time progress percentage
        let timeProgressPct = '—';
        let timeProgressColor = '';
        if (course.fecha_inicio && course.fecha_fin) {
            const inicio = new Date(course.fecha_inicio);
            const fin = new Date(course.fecha_fin);
            const hoy = new Date();
            const totalMs = fin - inicio;
            const elapsedMs = hoy - inicio;
            if (totalMs > 0) {
                const pct = Math.max(0, Math.min(100, (elapsedMs / totalMs) * 100));
                timeProgressPct = Math.round(pct) + '%';
                timeProgressColor = pct >= 100 ? 'red' : pct >= 75 ? 'amber' : 'blue';
            }
        }

        // Collect all unique SENCE IDs from students
        const senceIds = [...new Set(course.estudiantes.map(e => e.sence?.id_sence).filter(Boolean))];
        const senceDisplay = senceIds.length > 0 ? senceIds.join(', ') : '—';

        // Course link to platform
        const courseLink = `https://virtual.institutotecnipro.cl/course/view.php?id=${course.id_moodle}`;

        return `
        <div class="course-section${ci===0?' open':''}" data-course-id="${course.id_moodle}">
            <div class="course-header" onclick="toggleCourse(this)">
                <div class="course-header-left">
                    <input type="checkbox" class="course-checkbox" data-course-id="${course.id_moodle}" onclick="event.stopPropagation(); updateSelectedCourses();">
                    <span class="course-indicator ${indicator}"></span>
                    <span class="course-title">${course.nombre}</span>
                    <a href="${courseLink}" target="_blank" class="course-id-link" onclick="event.stopPropagation();" title="Abrir curso en plataforma">
                        <i class="fas fa-external-link-alt"></i> ID ${course.id_moodle}
                    </a>
                    ${course.modalidad ? `<span class="badge ${modalidadBadgeClass}">${course.modalidad}</span>` : ''}
                </div>
                <div class="course-meta">
                    <span class="course-meta-item"><i class="fas fa-users"></i> <strong><span class="student-count-display">${stats.total_estudiantes}</span></strong></span>
                    <span class="course-meta-item"><i class="fas fa-calendar"></i> ${daysLabel}</span>
                    <span class="course-meta-item" title="ID${senceIds.length > 1 ? 's' : ''} SENCE: ${senceDisplay}"><i class="fas fa-id-card"></i> SENCE ${senceDisplay}</span>
                </div>
                <div class="course-badges">
                    <span class="badge badge-green">${stats.aprobados} Aprob.</span>
                    ${stats.reprobados?`<span class="badge badge-red">${stats.reprobados} Reprob.</span>`:''}
                    ${stats.en_proceso?`<span class="badge badge-amber">${stats.en_proceso} Proc.</span>`:''}
                    ${stats.riesgo_alto?`<span class="badge badge-red"><i class="fas fa-exclamation-triangle"></i> ${stats.riesgo_alto}</span>`:''}
                </div>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="course-body">
                <div class="stats-row">
                    <div class="stat-mini"><div class="stat-mini-val blue">${stats.total_estudiantes}</div><div class="stat-mini-label">Participantes</div></div>
                    <div class="stat-mini"><div class="stat-mini-val">${stats.promedio_progreso}%</div><div class="stat-mini-label">Progreso Prom.</div></div>
                    <div class="stat-mini"><div class="stat-mini-val ${timeProgressColor}">${timeProgressPct}</div><div class="stat-mini-label">Avance Tiempo</div></div>
                    <div class="stat-mini"><div class="stat-mini-val green">${stats.aprobados}</div><div class="stat-mini-label">Aprobados</div></div>
                    <div class="stat-mini"><div class="stat-mini-val red">${stats.reprobados}</div><div class="stat-mini-label">Reprobados</div></div>
                    <div class="stat-mini"><div class="stat-mini-val amber">${stats.en_proceso}</div><div class="stat-mini-label">En Proceso</div></div>
                    <div class="stat-mini"><div class="stat-mini-val purple">${stats.conectados_sence}</div><div class="stat-mini-label">SENCE</div></div>
                </div>
                <div class="table-actions">
                    <div class="table-actions-left">
                        ${CURRENT_USER && CURRENT_USER.rol === 'admin' ? `<label class="select-all-label">
                            <input type="checkbox" onchange="toggleSelectAll(this,'${course.id_moodle}')">
                            Seleccionar todos
                        </label>` : ''}
                    </div>
                    <div style="font-size:.8rem;color:var(--slate-500);">
                        Empresa: <strong>${course.comprador?.empresa||'Sin asignar'}</strong>
                        ${course.comprador?.nombre?` · ${course.comprador.nombre}`:''}
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                ${CURRENT_USER && CURRENT_USER.rol === 'admin' ? '<th style="width:36px;"></th>' : ''}
                                <th onclick="sortTable('${course.id_moodle}','nombre')">Participante <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable('${course.id_moodle}','rut')">RUT <span class="sort-icon">⇅</span></th>
                                <th style="width:40px;text-align:center;" title="Correo electrónico"><i class="fas fa-envelope" style="font-size:.7rem;"></i></th>
                                <th onclick="sortTable('${course.id_moodle}','progreso')">Progreso <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable('${course.id_moodle}','calificacion')">Nota<br>Final <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable('${course.id_moodle}','evaluaciones')">Evalua-<br>ciones <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable('${course.id_moodle}','promedio_eval')">Prom.<br>Eval. <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable('${course.id_moodle}','estado')">Estado <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable('${course.id_moodle}','riesgo')">Riesgo <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable('${course.id_moodle}','id_sence')">ID<br>SENCE <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable('${course.id_moodle}','sence_ingresos')">Conex.<br>SENCE <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable('${course.id_moodle}','dias_sin_acceso')">Últ.<br>Conexión <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable('${course.id_moodle}','sence_dj')">DJ <span class="sort-icon">⇅</span></th>
                            </tr>
                        </thead>
                        <tbody id="tbody-${course.id_moodle}">
                            ${renderStudentRows(course)}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>`;
    }).join('');
}

function renderStudentRows(course) {
    // Calculate time progress % for this course
    let timeProgress = null;
    if (course.fecha_inicio && course.fecha_fin) {
        const inicio = new Date(course.fecha_inicio);
        const fin = new Date(course.fecha_fin);
        const hoy = new Date();
        const totalMs = fin - inicio;
        const elapsedMs = hoy - inicio;
        if (totalMs > 0) {
            timeProgress = Math.max(0, Math.min(100, (elapsedMs / totalMs) * 100));
            timeProgress = Math.round(timeProgress * 10) / 10;
        }
    }

    return course.estudiantes.map((s, i) => {
        const key = `${s.rut}_${course.id_moodle}`;
        const isSelected = selectedStudents.has(key);
        const progColor = s.progreso >= 80 ? 'var(--green-500)' : s.progreso >= 50 ? 'var(--amber-500)' : 'var(--red-500)';
        const gradeClass = s.calificacion === null ? 'grade-na' : s.calificacion >= 4 ? 'grade-pass' : 'grade-fail';
        const gradeText = s.calificacion !== null ? s.calificacion.toFixed(1) : '—';
        const statusLabel = s.estado==='A'?'Aprobado':s.estado==='R'?'Reprobado':'En proceso';
        const statusIcon = s.estado==='A'?'✓':s.estado==='R'?'✗':'◉';

        // ID SENCE y conexiones
        const idSence = s.sence && s.sence.id_sence ? s.sence.id_sence : null;
        const idSenceText = idSence ? idSence : 'Sin SENCE';
        const idSenceColor = idSence ? 'var(--slate-700)' : 'var(--slate-400)';

        // Si no tiene ID SENCE → mostrar "N/A" en conexiones
        const senceIngresos = idSence ? (s.sence.n_ingresos || 0) : 'N/A';
        const senceClass = idSence && s.sence.n_ingresos > 0 ? 'connected' : 'disconnected';
        const djText = idSence && s.sence && s.sence.estado_dj ? s.sence.estado_dj : (idSence ? '—' : 'N/A');
        const djColor = djText === 'Emitida' ? 'var(--green-600)' : 'var(--slate-400)';

        // Evaluation data
        const evaluacionesRendidas = s.evaluaciones_rendidas || 0;
        const totalEvaluaciones = s.total_evaluaciones || 0;
        const promedioEvaluadas = s.promedio_evaluadas;
        const resumenEvaluaciones = s.resumen_evaluaciones || (totalEvaluaciones > 0 ? `${evaluacionesRendidas}/${totalEvaluaciones}` : '—');

        const promedioEvalText = promedioEvaluadas !== null && promedioEvaluadas !== undefined
            ? promedioEvaluadas.toFixed(1)
            : '—';
        const promedioEvalClass = promedioEvaluadas !== null
            ? (promedioEvaluadas >= 4 ? 'grade-pass' : 'grade-fail')
            : 'grade-na';

        // Last connection display
        const diasSinAcceso = s.dias_sin_acceso;
        const ultimoAcceso = s.ultimo_acceso;
        let conexionText, conexionColor;
        if (diasSinAcceso === null || diasSinAcceso === undefined || (!ultimoAcceso && !diasSinAcceso)) {
            conexionText = 'Nunca';
            conexionColor = 'color:var(--red-600);font-weight:700;';
        } else if (diasSinAcceso === 0) {
            conexionText = 'Hoy';
            conexionColor = 'color:var(--green-600);font-weight:700;';
        } else if (diasSinAcceso === 1) {
            conexionText = 'Ayer';
            conexionColor = 'color:var(--green-600);font-weight:600;';
        } else {
            conexionText = `${diasSinAcceso} días`;
            conexionColor = diasSinAcceso > 7 ? 'color:var(--red-600);font-weight:700;' : diasSinAcceso > 3 ? 'color:var(--amber-600);font-weight:600;' : 'color:var(--slate-600);';
        }
        const conexionTitle = ultimoAcceso ? `Último acceso: ${ultimoAcceso}` : 'Sin registro de acceso';

        const isAdmin = CURRENT_USER && CURRENT_USER.rol === 'admin';
        return `
        <tr data-student-idx="${i}" class="${isSelected?'selected':''}">
            ${isAdmin ? `<td class="cb-cell">
                <input type="checkbox" ${isSelected?'checked':''}
                    onchange="toggleStudent(this,'${course.id_moodle}',${i})">
            </td>` : ''}
            <td><strong>${s.nombre}</strong></td>
            <td class="rut-cell">${s.rut}</td>
            <td class="email-icon-cell" style="text-align:center;">
                <div class="email-tooltip-wrap">
                    <i class="fas fa-envelope email-icon-btn" title="${s.email}"></i>
                    <div class="email-tooltip-box">
                        <span class="email-tooltip-text">${s.email}</span>
                        <button class="email-copy-btn" onclick="event.stopPropagation();copyEmail('${s.email}',this);" title="Copiar correo">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </td>
            <td class="progress-cell">
                <div class="progress-bar-bg" style="position:relative;">
                    <div class="progress-bar-fill" style="width:${s.progreso}%;background:${progColor};"></div>
                    ${timeProgress !== null ? `<div class="time-marker" style="left:${timeProgress}%;" title="Avance del curso: ${timeProgress.toFixed(0)}% del tiempo transcurrido"></div>` : ''}
                </div>
                <div class="progress-text" style="color:${progColor}">${s.progreso}%</div>
            </td>
            <td><span class="grade ${gradeClass}">${gradeText}</span></td>
            <td class="text-center mono" style="font-size:.82rem;font-weight:600;color:var(--slate-600);">${resumenEvaluaciones}</td>
            <td><span class="grade ${promedioEvalClass}">${promedioEvalText}</span></td>
            <td><span class="status status-${s.estado.toLowerCase()}">${statusIcon} ${statusLabel}</span></td>
            <td>${s.riesgo ? `<span class="risk risk-${s.riesgo}">${s.riesgo.charAt(0).toUpperCase()+s.riesgo.slice(1)}</span>` : '<span style="color:var(--slate-400);">—</span>'}</td>
            <td class="text-center" style="font-size:.85rem;font-weight:600;color:${idSenceColor};" title="${idSence ? 'ID SENCE del participante' : 'Sin código SENCE asignado'}">${idSenceText}</td>
            <td>
                <span class="sence-chip ${senceClass}">
                    <i class="fas ${senceClass==='connected'?'fa-plug':'fa-plug-circle-xmark'}"></i>
                    <span class="sence-num">${senceIngresos}</span>
                </span>
            </td>
            <td class="text-center mono" style="font-size:.82rem;${conexionColor}" title="${conexionTitle}">${conexionText}</td>
            <td style="color:${djColor};font-weight:600;font-size:.82rem;">${djText}</td>
        </tr>`;
    }).join('');
}

// ═══════════════════════════════════════════════════════
// INTERACTIONS
// ═══════════════════════════════════════════════════════
function toggleCourse(el) {
    el.closest('.course-section').classList.toggle('open');
}

function toggleStudent(cb, courseId, idx) {
    const course = DATA.cursos.find(c => c.id_moodle === courseId);
    const student = course.estudiantes[idx];
    const key = `${student.rut}_${courseId}`;

    if (cb.checked) {
        selectedStudents.set(key, { student, courseName: course.nombre });
        cb.closest('tr').classList.add('selected');
    } else {
        selectedStudents.delete(key);
        cb.closest('tr').classList.remove('selected');
    }
    updateFab();
}

function toggleSelectAll(cb, courseId) {
    const course = DATA.cursos.find(c => c.id_moodle === courseId);
    const tbody = document.getElementById(`tbody-${courseId}`);
    const checkboxes = tbody.querySelectorAll('input[type="checkbox"]');

    checkboxes.forEach((checkbox, idx) => {
        const row = checkbox.closest('tr');
        if (row.style.display === 'none') return; // skip filtered out
        const student = course.estudiantes[parseInt(row.dataset.studentIdx)];
        const key = `${student.rut}_${courseId}`;

        checkbox.checked = cb.checked;
        if (cb.checked) {
            selectedStudents.set(key, { student, courseName: course.nombre });
            row.classList.add('selected');
        } else {
            selectedStudents.delete(key);
            row.classList.remove('selected');
        }
    });
    updateFab();
}

function updateFab() {
    const fab = document.getElementById('fabEmail');
    const count = selectedStudents.size;
    document.getElementById('fabCount').textContent = count;
    if (count > 0) {
        fab.classList.add('visible');
    } else {
        fab.classList.remove('visible');
    }
}

// ═══════════════════════════════════════════════════════
// SORTING
// ═══════════════════════════════════════════════════════
function sortTable(courseId, field) {
    const course = DATA.cursos.find(c => c.id_moodle === courseId);
    if (!sortState[courseId]) sortState[courseId] = { field, asc: true };
    else if (sortState[courseId].field === field) sortState[courseId].asc = !sortState[courseId].asc;
    else sortState[courseId] = { field, asc: true };

    const { asc } = sortState[courseId];

    course.estudiantes.sort((a, b) => {
        let va, vb;
        switch(field) {
            case 'nombre': va=a.nombre; vb=b.nombre; break;
            case 'rut': va=a.rut; vb=b.rut; break;
            case 'email': va=a.email; vb=b.email; break;
            case 'progreso': va=a.progreso; vb=b.progreso; break;
            case 'calificacion': va=a.calificacion??-1; vb=b.calificacion??-1; break;
            case 'evaluaciones': va=a.evaluaciones_rendidas??0; vb=b.evaluaciones_rendidas??0; break;
            case 'promedio_eval': va=a.promedio_evaluadas??-1; vb=b.promedio_evaluadas??-1; break;
            case 'estado': va=a.estado; vb=b.estado; break;
            case 'riesgo': va={alto:3,medio:2,bajo:1}[a.riesgo]||0; vb={alto:3,medio:2,bajo:1}[b.riesgo]||0; break;
            case 'id_sence': va=a.sence?.id_sence||''; vb=b.sence?.id_sence||''; break;
            case 'sence_ingresos': va=a.sence?.n_ingresos??-1; vb=b.sence?.n_ingresos??-1; break;
            case 'sence_dj': va=a.sence?.estado_dj||''; vb=b.sence?.estado_dj||''; break;
            case 'dias_sin_acceso': va=a.dias_sin_acceso||0; vb=b.dias_sin_acceso||0; break;
            default: va=0; vb=0;
        }
        if (typeof va === 'string') return asc ? va.localeCompare(vb) : vb.localeCompare(va);
        return asc ? va-vb : vb-va;
    });

    document.getElementById(`tbody-${courseId}`).innerHTML = renderStudentRows(course);
    applyFilters();
}

// ═══════════════════════════════════════════════════════
// EMAIL MODAL
// ═══════════════════════════════════════════════════════
function openEmailModal() {
    const overlay = document.getElementById('emailModalOverlay');
    overlay.classList.add('open');

    const list = document.getElementById('selectedList');
    const entries = [...selectedStudents.values()];
    document.getElementById('modalCount').textContent = entries.length;

    list.innerHTML = entries.map(e => `
        <div class="sel-student">
            <div>
                <div class="sel-student-name">${e.student.nombre}</div>
                <div class="sel-student-email">${e.student.email}</div>
            </div>
            <div class="sel-student-course">${e.courseName}</div>
        </div>
    `).join('');

    updateEmailPreview();
}

function closeEmailModal() {
    document.getElementById('emailModalOverlay').classList.remove('open');
}

function updateEmailPreview() {
    const subject = document.getElementById('emailSubject').value;
    const body = document.getElementById('emailBody').value;
    const entries = [...selectedStudents.values()];
    const emails = entries.map(e => e.student.email).join(', ');

    document.getElementById('emailPreview').innerHTML =
        `<strong>Para:</strong> ${emails}\n<strong>Asunto:</strong> ${subject}\n\n${body}`;
}

async function sendEmails() {
    const entries = [...selectedStudents.values()];
    const emails = entries.map(e => e.student.email).filter(e => e);
    const subject = document.getElementById('emailSubject').value;
    const body = document.getElementById('emailBody').value;

    if (!emails.length) {
        showToast('No hay destinatarios con correo válido', 'error');
        return;
    }

    const btn = document.getElementById('btnSendEmail');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
    btn.disabled = true;

    try {
        const response = await fetch('/api/enviar-correo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                destinatarios: emails,
                asunto: subject,
                cuerpo: body,
            }),
        });
        const result = await response.json();

        if (response.ok) {
            showToast(`Correo enviado a ${result.enviados} destinatario(s)`, 'success');
            closeEmailModal();
            // Limpiar selección
            selectedStudents.clear();
            document.querySelectorAll('tr.selected').forEach(tr => tr.classList.remove('selected'));
            document.querySelectorAll('td.cb-cell input:checked').forEach(cb => { cb.checked = false; });
            updateFab();
        } else {
            showToast(result.error || 'Error al enviar correo', 'error');
        }
    } catch (error) {
        showToast(`Error de conexión: ${error.message}`, 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function showToast(message, type, duration = 4000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast toast-${type} visible`;
    setTimeout(() => { toast.classList.remove('visible'); }, duration);
}

// Close modal on overlay click
document.getElementById('emailModalOverlay').addEventListener('click', function(e) {
    if (e.target === this) closeEmailModal();
});

// Update preview on input changes
document.getElementById('emailSubject')?.addEventListener('input', updateEmailPreview);
document.getElementById('emailBody')?.addEventListener('input', updateEmailPreview);

// ═══════════════════════════════════════════════════════
// DESCARGAR EXCEL
// ═══════════════════════════════════════════════════════
function descargarTodo() {
    // Obtener IDs de cursos visibles (aplicando filtros)
    const cursosVisibles = [];
    document.querySelectorAll('.course-section').forEach(section => {
        if (section.style.display !== 'none') {
            cursosVisibles.push(section.dataset.courseId);
        }
    });

    // Construir URL con parámetros
    let url = '/api/descargar-excel';
    if (cursosVisibles.length > 0) {
        url += '?cursos=' + cursosVisibles.join(',');
    }

    // Abrir URL para descargar
    window.location.href = url;
}

function descargarSeleccion() {
    // Obtener IDs de cursos seleccionados
    const cursosSeleccionados = [];
    document.querySelectorAll('.course-checkbox:checked').forEach(checkbox => {
        cursosSeleccionados.push(checkbox.dataset.courseId);
    });

    if (cursosSeleccionados.length === 0) {
        alert('Seleccione al menos un curso para descargar');
        return;
    }

    // Construir URL con parámetros
    const url = '/api/descargar-excel?cursos=' + cursosSeleccionados.join(',');
    window.location.href = url;
}

function updateSelectedCourses() {
    // Contar checkboxes seleccionados
    const count = document.querySelectorAll('.course-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = count;

    // Habilitar/deshabilitar botón de descarga selección
    const btnSeleccion = document.getElementById('btnExcelSeleccion');
    if (count > 0) {
        btnSeleccion.disabled = false;
        btnSeleccion.title = `Descargar ${count} curso${count > 1 ? 's' : ''} seleccionado${count > 1 ? 's' : ''}`;
    } else {
        btnSeleccion.disabled = true;
        btnSeleccion.title = 'Seleccione al menos un curso';
    }
}

// ═══════════════════════════════════════════════════════
// REFRESH MOODLE DATA
// ═══════════════════════════════════════════════════════
function checkDataAge() {
    // Check if Moodle data is older than 1 hour and show warning
    if (!DATA || !DATA.metadata) return;
    const fechaRef = DATA.metadata.fecha_moodle || DATA.metadata.fecha_procesamiento;
    if (!fechaRef) return;

    const dataDate = new Date(fechaRef);
    const now = new Date();
    const ageInHours = (now - dataDate) / (1000 * 60 * 60);

    const warningBox = document.getElementById('dataAgeWarning');
    const warningText = document.getElementById('dataAgeText');

    if (ageInHours > 1) {
        // Data is old - show warning
        const hoursAgo = Math.floor(ageInHours);
        warningText.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Datos con ${hoursAgo}h de antigüedad`;
        warningBox.style.display = '';

        // Show refresh buttons (todos los usuarios pueden actualizar cuando hay data vieja)
        if (CURRENT_USER) {
            document.getElementById('btnRefresh').style.display = '';

            // Botones solo para admin
            if (CURRENT_USER.rol === 'admin') {
                document.getElementById('btnCoordinadores').style.display = '';

                // Actualización completa solo para superadmins
                const SUPERADMINS = ['ygonzalez@duocapital.cl', 'jortizleiva@duocapital.cl'];
                if (SUPERADMINS.includes(CURRENT_USER.email)) {
                    document.getElementById('btnRefreshFull').style.display = '';
                }
            }
        }
    } else {
        warningBox.style.display = 'none';
    }
}

async function refreshMoodleData(courseIds = null) {
    // courseIds: array de IDs numéricos para actualizar solo esos cursos (admin)
    //            null = actualizar todos
    const btn = document.getElementById('btnRefresh');
    const btnSelect = document.getElementById('btnRefreshSelect');
    const originalHTML = btn ? btn.innerHTML : '';

    if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...'; }
    if (btnSelect) { btnSelect.disabled = true; }

    const msgCursos = courseIds
        ? `⏳ Actualizando ${courseIds.length} curso${courseIds.length > 1 ? 's' : ''} seleccionado${courseIds.length > 1 ? 's' : ''}...`
        : '⏳ Actualizando datos desde Moodle... Este proceso puede demorar hasta 5 minutos.';
    showToast(msgCursos, 'info', 300000);

    try {
        // Iniciar proceso en background y obtener job_id
        const body = courseIds ? { course_ids: courseIds } : {};
        const response = await fetch('/api/refresh', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });

        const result = await response.json().catch(() => ({ error: "Error al iniciar actualización." }));

        // Helper para rehabilitar los botones de refresh
        function _restoreRefreshBtns() {
            if (btn) { btn.disabled = false; btn.innerHTML = originalHTML; }
            if (btnSelect) btnSelect.disabled = false;
        }

        if (response.status === 409) {
            showToast('⏳ Ya hay una actualización en proceso. Espere a que termine.', 'info', 8000);
            _restoreRefreshBtns();
            return;
        }

        if (!response.ok || !result.job_id) {
            showToast(result.error || 'Error al iniciar actualización', 'error');
            _restoreRefreshBtns();
            return;
        }

        // Polling cada 5 segundos hasta que el proceso termine
        const jobId = result.job_id;
        let pollCount = 0;
        const MAX_POLLS = 90; // 90 × 5s = 7.5 minutos máximo

        const pollInterval = setInterval(async () => {
            pollCount++;
            if (pollCount > MAX_POLLS) {
                clearInterval(pollInterval);
                showToast('El proceso tardó demasiado. Intente nuevamente.', 'error');
                _restoreRefreshBtns();
                return;
            }

            try {
                const statusResp = await fetch(`/api/refresh-status/${jobId}`);
                const statusData = await statusResp.json().catch(() => ({ status: 'running' }));

                if (statusData.status === 'ok') {
                    clearInterval(pollInterval);
                    showToast('✓ Datos actualizados exitosamente', 'success', 3000);
                    setTimeout(() => { window.location.reload(); }, 1500);
                } else if (statusData.status === 'error') {
                    clearInterval(pollInterval);
                    showToast(statusData.message || 'Error al actualizar datos', 'error');
                    _restoreRefreshBtns();
                }
            } catch (err) {
                // Error de red temporal, seguir intentando
            }
        }, 5000);

    } catch (error) {
        showToast(`Error de conexión: ${error.message}`, 'error');
        if (btn) { btn.disabled = false; btn.innerHTML = originalHTML; }
        if (btnSelect) btnSelect.disabled = false;
    }
}

// Variable global para controlar la cancelación
let fullRefreshController = null;

function disableAllButtons() {
    // Deshabilitar todos los botones de acción
    const buttons = document.querySelectorAll('button:not(#btnCancelRefresh)');
    buttons.forEach(btn => {
        if (!btn.disabled) {
            btn.disabled = true;
            btn.dataset.wasEnabled = 'true';
        }
    });
}

function enableAllButtons() {
    // Re-habilitar botones que estaban habilitados
    const buttons = document.querySelectorAll('button[data-was-enabled="true"]');
    buttons.forEach(btn => {
        btn.disabled = false;
        delete btn.dataset.wasEnabled;
    });
}

async function refreshFullData() {
    const btn = document.getElementById('btnRefreshFull');
    const originalHTML = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando...';

    try {
        const response = await fetch('/api/refresh-full', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (response.ok && result.status === 'started') {
            // Proceso iniciado exitosamente en segundo plano
            showToast(
                '✅ Actualización completa iniciada en segundo plano. ' +
                'El proceso puede tomar 5-30 minutos. ' +
                'Recibirá un correo cuando finalice.',
                'success',
                10000
            );

            // Re-habilitar el botón después de 2 segundos
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }, 2000);
        } else {
            showToast(result.error || 'Error al iniciar actualización completa', 'error');
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    } catch (error) {
        showToast(`Error de conexión: ${error.message}`, 'error');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

// ═══════════════════════════════════════════════════════
// COPY EMAIL
// ═══════════════════════════════════════════════════════
function copyEmail(email, btn) {
    navigator.clipboard.writeText(email).then(() => {
        const icon = btn.querySelector('i');
        icon.className = 'fas fa-check';
        btn.style.background = 'rgba(34,197,94,.3)';
        setTimeout(() => {
            icon.className = 'fas fa-copy';
            btn.style.background = '';
        }, 1500);
    }).catch(() => {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = email;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('Correo copiado', 'success');
    });
}

// ═══════════════════════════════════════════════════════
// PRINT REPORT
// ═══════════════════════════════════════════════════════
function printReport() {
    // Open all course sections before printing
    document.querySelectorAll('.course-section').forEach(s => s.classList.add('open'));

    // Set data-email attribute on email cells for print
    document.querySelectorAll('.email-icon-cell').forEach(cell => {
        const icon = cell.querySelector('.email-icon-btn');
        if (icon) cell.setAttribute('data-email', icon.getAttribute('title') || '');
    });

    // Small delay to let DOM update, then print
    setTimeout(() => {
        window.print();
    }, 300);
}

// ═══════════════════════════════════════════════════════
// COORDINADORES CLIENTE - GESTIÓN
// ═══════════════════════════════════════════════════════

let coordinadoresData = [];

async function abrirModalCoordinadores() {
    const modal = document.getElementById('modalCoordinadores');
    modal.classList.add('active');
    await cargarCoordinadores();
}

function cerrarModalCoordinadores() {
    const modal = document.getElementById('modalCoordinadores');
    modal.classList.remove('active');
    cancelarEdicion();
}

async function cargarCoordinadores() {
    try {
        const response = await fetch('/api/coordinadores');
        if (!response.ok) throw new Error('Error al cargar coordinadores');

        const data = await response.json();
        coordinadoresData = data.coordinadores;

        renderizarTablaCoordinadores();
    } catch (error) {
        console.error('Error cargando coordinadores:', error);
        document.getElementById('coordTableBody').innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; color: var(--red-600); padding: 2rem;">
                    <i class="fas fa-exclamation-triangle"></i> Error al cargar coordinadores
                </td>
            </tr>
        `;
    }
}

function renderizarTablaCoordinadores() {
    const tbody = document.getElementById('coordTableBody');

    if (coordinadoresData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; color: var(--slate-500); padding: 2rem;">
                    <i class="fas fa-inbox"></i> No hay coordinadores registrados
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = coordinadoresData.map(coord => {
        const cursosArray = coord.cursos || [];
        const cursosBadges = cursosArray.length > 0
            ? cursosArray.map(c => `<span class="course-badge">${c}</span>`).join(' ')
            : '<span style="color:var(--slate-400);font-size:.8rem;">Sin cursos</span>';
        const emailEscaped = coord.email.replace(/'/g, "\\'");
        const nombreEscaped = coord.nombre.replace(/'/g, "\\'");

        const activo = coord.activo !== false;
        const estadoBadge = activo
            ? '<span style="background:var(--green-100);color:var(--green-700);padding:.2rem .5rem;border-radius:4px;font-size:.75rem;font-weight:600;"><i class="fas fa-check-circle"></i> Activo</span>'
            : '<span style="background:var(--red-100);color:var(--red-600);padding:.2rem .5rem;border-radius:4px;font-size:.75rem;font-weight:600;"><i class="fas fa-ban"></i> Inactivo</span>';

        const toggleIcon = activo ? 'fa-user-slash' : 'fa-user-check';
        const toggleTitle = activo ? 'Desactivar acceso' : 'Reactivar acceso';

        const ultimoAcceso = coord.ultimo_acceso
            ? `<span style="font-size:.72rem;color:var(--slate-400);">${coord.ultimo_acceso}</span>`
            : '<span style="font-size:.72rem;color:var(--slate-400);">Sin acceso</span>';

        return `
            <tr style="${!activo ? 'opacity:.6;background:var(--slate-50);' : ''}">
                <td>
                    <strong>${coord.nombre}</strong><br>
                    ${ultimoAcceso}
                </td>
                <td style="font-size:.85rem;">${coord.email}</td>
                <td>${coord.empresa || '—'}</td>
                <td>${cursosBadges}</td>
                <td style="text-align:center;">${estadoBadge}</td>
                <td class="coord-actions" style="justify-content:center;flex-wrap:wrap;gap:.3rem;">
                    <button class="btn-icon btn-edit" onclick="editarCoordinador('${emailEscaped}')" title="Editar datos y cursos">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon btn-key" onclick="resetPasswordCoordinador('${emailEscaped}', '${nombreEscaped}')" title="Restablecer contraseña">
                        <i class="fas fa-key"></i>
                    </button>
                    <button class="btn-icon" onclick="toggleCoordinador('${emailEscaped}', '${nombreEscaped}', ${activo})" title="${toggleTitle}" style="border-color:${activo ? 'var(--amber-400)' : 'var(--green-400)'};color:${activo ? 'var(--amber-600)' : 'var(--green-600)'};">
                        <i class="fas ${toggleIcon}"></i>
                    </button>
                    <button class="btn-icon btn-delete" onclick="eliminarCoordinador('${emailEscaped}', '${nombreEscaped}')" title="Eliminar permanentemente">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

async function guardarCoordinador(event) {
    event.preventDefault();

    const coordEmail = document.getElementById('coordEmail').value;
    const esEdicion = coordEmail !== '';

    const data = {
        nombre: document.getElementById('coordNombre').value.trim(),
        email: document.getElementById('coordEmailInput').value.trim(),
        cursos: document.getElementById('coordCursos').value.trim(),
        empresa: document.getElementById('coordEmpresa').value.trim()
    };

    try {
        let response;
        if (esEdicion) {
            response = await fetch(`/api/coordinadores/${coordEmail}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        } else {
            response = await fetch('/api/coordinadores', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        if (!response.ok) {
            const error = await response.json();
            alert(error.error || 'Error al guardar coordinador');
            return;
        }

        const result = await response.json();
        await cargarCoordinadores();

        if (esEdicion) {
            cancelarEdicion();
            showCoordToast('Coordinador actualizado exitosamente', 'success');
        } else {
            // Creación: mostrar pantalla de éxito
            const password = result.password_generada;
            if (password) {
                document.getElementById('generatedPassword').textContent = password;
                document.getElementById('successEmail').textContent = data.email;
                document.getElementById('coordFormSection').style.display = 'none';
                document.getElementById('coordSuccessSection').style.display = 'block';
            } else {
                cancelarEdicion();
                showCoordToast('Coordinador creado exitosamente', 'success');
            }
        }

    } catch (error) {
        console.error('Error guardando coordinador:', error);
        alert('Error al guardar coordinador. Intente nuevamente.');
    }
}

function editarCoordinador(email) {
    const coord = coordinadoresData.find(c => c.email === email);
    if (!coord) return;

    document.getElementById('coordFormSection').style.display = 'block';
    document.getElementById('coordSuccessSection').style.display = 'none';

    document.getElementById('coordEmail').value = coord.email;
    document.getElementById('coordNombre').value = coord.nombre;
    document.getElementById('coordNombre').disabled = false;
    document.getElementById('coordEmailInput').value = coord.email;
    document.getElementById('coordEmailInput').disabled = true;
    document.getElementById('coordCursos').value = coord.cursos ? coord.cursos.join(', ') : '';
    document.getElementById('coordEmpresa').value = coord.empresa || '';

    document.getElementById('formTitle').textContent = `Editar — ${coord.nombre}`;
    document.getElementById('btnGuardarText').textContent = 'Guardar Cambios';

    document.querySelector('.coord-form').scrollIntoView({ behavior: 'smooth' });
    setTimeout(() => document.getElementById('coordNombre').focus(), 300);
}

function cancelarEdicion() {
    document.getElementById('formCoordinador').reset();
    document.getElementById('coordEmail').value = '';
    document.getElementById('coordNombre').disabled = false;
    document.getElementById('coordEmailInput').disabled = false;
    document.getElementById('formTitle').textContent = 'Agregar Nuevo Coordinador';
    document.getElementById('btnGuardarText').textContent = 'Crear Coordinador';

    document.getElementById('coordFormSection').style.display = 'block';
    document.getElementById('coordSuccessSection').style.display = 'none';
}

function copiarPassword() {
    const password = document.getElementById('generatedPassword').textContent;
    navigator.clipboard.writeText(password).then(() => {
        showCoordToast('Contraseña copiada al portapapeles', 'success');
    }).catch(err => {
        console.error('Error copiando:', err);
        alert('Error al copiar contraseña');
    });
}

function agregarOtroCoordinador() {
    document.getElementById('coordFormSection').style.display = 'block';
    document.getElementById('coordSuccessSection').style.display = 'none';
    cancelarEdicion();
    document.querySelector('.coord-form').scrollIntoView({ behavior: 'smooth' });
}

async function resetPasswordCoordinador(email, nombre) {
    if (!confirm(`¿Restablecer la contraseña de "${nombre}"?\n\nSe generará una nueva contraseña y se enviará por email a ${email}.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/coordinadores/${email}/reset-password`, {
            method: 'POST'
        });

        if (!response.ok) {
            const error = await response.json();
            alert(error.error || 'Error al restablecer contraseña');
            return;
        }

        const result = await response.json();
        const newPassword = result.password_generada;

        if (newPassword) {
            // Mostrar nueva contraseña en sección éxito
            document.getElementById('generatedPassword').textContent = newPassword;
            document.getElementById('successEmail').textContent = email;
            document.querySelector('#coordSuccessSection h3').textContent = 'Contraseña Restablecida';
            document.getElementById('coordFormSection').style.display = 'none';
            document.getElementById('coordSuccessSection').style.display = 'block';
        } else {
            showCoordToast(`Contraseña restablecida para ${nombre}. Se envió por email.`, 'success');
        }

    } catch (error) {
        console.error('Error restableciendo contraseña:', error);
        alert('Error al restablecer contraseña. Intente nuevamente.');
    }
}

async function eliminarCoordinador(email, nombre) {
    // Primera confirmación
    if (!confirm(`¿Eliminar PERMANENTEMENTE al coordinador "${nombre}"?\n\n⚠️ Se eliminará su cuenta y todos sus datos.\n\n💡 Si solo quiere bloquear el acceso, use el botón de desactivar en su lugar.`)) {
        return;
    }

    // Segunda confirmación - escribir email
    const confirmacion = prompt(`Para confirmar la eliminación permanente, escriba el email del coordinador:\n\n${email}`);
    if (confirmacion !== email) {
        if (confirmacion !== null) {
            alert('El email no coincide. Eliminación cancelada.');
        }
        return;
    }

    try {
        const response = await fetch(`/api/coordinadores/${email}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const error = await response.json();
            alert(error.error || 'Error al eliminar coordinador');
            return;
        }

        await cargarCoordinadores();
        cancelarEdicion();
        showCoordToast('Coordinador eliminado permanentemente', 'success');

    } catch (error) {
        console.error('Error eliminando coordinador:', error);
        alert('Error al eliminar coordinador. Intente nuevamente.');
    }
}

async function toggleCoordinador(email, nombre, estaActivo) {
    const accion = estaActivo ? 'desactivar' : 'reactivar';
    const mensaje = estaActivo
        ? `¿Desactivar a "${nombre}"?\n\nEl usuario no podrá acceder al dashboard pero su cuenta se mantendrá.\nPodrá reactivarlo en cualquier momento.`
        : `¿Reactivar a "${nombre}"?\n\nEl usuario podrá acceder nuevamente al dashboard con su cuenta existente.`;

    if (!confirm(mensaje)) return;

    try {
        const response = await fetch(`/api/coordinadores/${email}/toggle-status`, {
            method: 'POST'
        });

        if (!response.ok) {
            const error = await response.json();
            alert(error.error || `Error al ${accion} coordinador`);
            return;
        }

        await cargarCoordinadores();
        showCoordToast(`Coordinador ${estaActivo ? 'desactivado' : 'reactivado'} exitosamente`, 'success');

    } catch (error) {
        console.error(`Error al ${accion}:`, error);
        alert(`Error al ${accion} coordinador. Intente nuevamente.`);
    }
}

function showCoordToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: ${type === 'success' ? 'var(--green-600)' : 'var(--blue-600)'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: var(--radius-xs);
        box-shadow: var(--shadow-lg);
        z-index: 10000;
        animation: slideInRight .3s ease;
        font-weight: 600;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity .3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>

<!-- Modal Coordinadores Cliente -->
<div class="modal-overlay" id="modalCoordinadores">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-users-cog"></i> Gestionar Coordinadores Cliente</h2>
            <button class="modal-close" onclick="cerrarModalCoordinadores()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- ESTADO 1: Formulario crear/editar -->
            <div class="coord-form" id="coordFormSection">
                <h3 id="formTitle">Agregar Nuevo Coordinador</h3>
                <form id="formCoordinador" onsubmit="guardarCoordinador(event)">
                    <input type="hidden" id="coordEmail" value="">
                    <div class="form-row">
                        <div class="form-group" id="groupNombre">
                            <label for="coordNombre">Nombre Completo *</label>
                            <input type="text" id="coordNombre" required placeholder="Ej: María González">
                        </div>
                        <div class="form-group" id="groupEmail">
                            <label for="coordEmailInput">Email *</label>
                            <input type="email" id="coordEmailInput" required placeholder="Ej: mgonzalez@empresa.cl">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="coordCursos">IDs de Cursos Moodle *</label>
                            <input type="text" id="coordCursos" required placeholder="Ej: 190, 192, 193, 304">
                            <small style="font-size: .75rem; color: var(--slate-500); margin-top: .25rem; display: block;">
                                <i class="fas fa-info-circle"></i> Separar múltiples cursos con comas. Los IDs se muestran en la cabecera de cada curso.
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="coordEmpresa">Empresa</label>
                            <input type="text" id="coordEmpresa" placeholder="Ej: Empresa ABC Ltda">
                        </div>
                    </div>
                    <div style="display: flex; gap: .75rem; justify-content: flex-end;">
                        <button type="button" class="btn-secondary" onclick="cancelarEdicion()">Cancelar</button>
                        <button type="submit" class="btn-primary" id="btnGuardarCoord">
                            <i class="fas fa-save"></i> <span id="btnGuardarText">Crear Coordinador</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- ESTADO 2: Éxito al crear (reemplaza el formulario) -->
            <div id="coordSuccessSection" style="display:none;">
                <div style="background: var(--green-100); border: 1px solid var(--green-500); border-radius: var(--radius); padding: 2rem; text-align: center;">
                    <div style="width: 60px; height: 60px; background: var(--green-600); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                        <i class="fas fa-check" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <h3 style="color: var(--green-700); font-size: 1.2rem; margin-bottom: .5rem;">Coordinador Creado Exitosamente</h3>
                    <p style="color: var(--slate-600); font-size: .9rem; margin-bottom: 1rem;">
                        Se creó la cuenta para <strong id="successEmail"></strong>
                    </p>
                    <div style="background: white; padding: 1rem; border-radius: var(--radius-xs); border: 1px solid var(--slate-300); max-width: 400px; margin: 0 auto 1rem;">
                        <strong style="font-size: .8rem; color: var(--slate-600); display: block; margin-bottom: .35rem;">Contraseña generada:</strong>
                        <div style="display: flex; align-items: center; gap: .5rem;">
                            <code id="generatedPassword" style="flex: 1; font-size: 1.1rem; color: var(--slate-800); background: var(--slate-100); padding: .5rem; border-radius: var(--radius-xs); font-family: 'JetBrains Mono', monospace;"></code>
                            <button type="button" class="btn-icon" onclick="copiarPassword()" title="Copiar contraseña">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <p style="font-size: .8rem; color: var(--blue-700); background: var(--blue-50); padding: .65rem; border-radius: var(--radius-xs); border: 1px solid var(--blue-200); max-width: 400px; margin: 0 auto 1.25rem;">
                        <i class="fas fa-paper-plane"></i> Se envió un correo con las credenciales al usuario.
                    </p>
                    <div style="display: flex; gap: .75rem; justify-content: center;">
                        <button type="button" class="btn-primary" onclick="agregarOtroCoordinador()">
                            <i class="fas fa-plus"></i> Agregar Otro
                        </button>
                        <button type="button" class="btn-secondary" onclick="cerrarModalCoordinadores()">
                            <i class="fas fa-check"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabla de coordinadores existentes -->
            <div id="coordTableSection">
                <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--slate-800); margin-bottom: 1rem;">
                    <i class="fas fa-list"></i> Coordinadores Registrados
                </h3>
                <table class="coord-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Empresa</th>
                            <th>Cursos Asignados</th>
                            <th style="width: 80px; text-align: center;">Estado</th>
                            <th style="width: 170px; text-align: center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="coordTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; color: var(--slate-500); padding: 2rem;">
                                <i class="fas fa-spinner fa-spin"></i> Cargando coordinadores...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Cerrar modal al hacer clic fuera del contenido
document.getElementById('modalCoordinadores').addEventListener('click', (e) => {
    if (e.target.id === 'modalCoordinadores') {
        cerrarModalCoordinadores();
    }
});
</script>

<!-- ══════════════════════════════════════════════════════ -->
<!-- MODAL: Actualizar cursos elegidos (solo admin)         -->
<!-- ══════════════════════════════════════════════════════ -->
<div class="modal-overlay" id="modalRefreshCursos" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:9999; align-items:center; justify-content:center;">
    <div class="modal-content" style="max-width:560px; width:95%; max-height:90vh; display:flex; flex-direction:column; border-radius:12px; overflow:hidden; background:#fff; box-shadow:0 20px 60px rgba(0,0,0,.25);">

        <!-- Cabecera -->
        <div class="modal-header" style="background:linear-gradient(135deg,#0f766e,#0891b2); color:#fff; padding:1.1rem 1.5rem; display:flex; align-items:center; justify-content:space-between; flex-shrink:0;">
            <h2 style="margin:0; font-size:1.1rem; font-weight:700;">
                <i class="fas fa-filter" style="margin-right:.5rem;"></i>Actualizar cursos elegidos
            </h2>
            <button onclick="cerrarModalRefreshCursos()" style="background:rgba(255,255,255,.15); border:none; color:#fff; width:32px; height:32px; border-radius:50%; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center;">✕</button>
        </div>

        <!-- Cuerpo -->
        <div style="padding:1.25rem 1.5rem; flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:.85rem;">
            <p style="margin:0; color:var(--slate-500); font-size:.85rem;">
                Selecciona uno o más cursos. Solo se actualizará la información de los cursos que elijas, ahorrando tiempo de procesamiento.
            </p>

            <!-- Buscador -->
            <input
                type="text"
                id="filtroCursosModal"
                placeholder="&#xf002; Buscar curso por nombre..."
                oninput="filtrarCursosModal()"
                style="width:100%; padding:.6rem .9rem; border:1px solid var(--slate-300); border-radius:8px; font-size:.875rem; outline:none; box-sizing:border-box;"
            >

            <!-- Acciones rápidas -->
            <div style="display:flex; gap:.5rem;">
                <button onclick="seleccionarTodosCursosModal()" style="flex:1; padding:.45rem; background:var(--slate-100); border:1px solid var(--slate-300); border-radius:6px; font-size:.8rem; cursor:pointer; color:var(--slate-700);">
                    <i class="fas fa-check-double"></i> Todos
                </button>
                <button onclick="limpiarSeleccionCursosModal()" style="flex:1; padding:.45rem; background:var(--slate-100); border:1px solid var(--slate-300); border-radius:6px; font-size:.8rem; cursor:pointer; color:var(--slate-700);">
                    <i class="fas fa-times"></i> Limpiar
                </button>
            </div>

            <!-- Lista de cursos -->
            <div id="listaCursosModal" style="border:1px solid var(--slate-200); border-radius:8px; overflow-y:auto; max-height:280px; min-height:80px;">
                <p style="text-align:center; color:var(--slate-400); padding:2rem; margin:0;">Cargando cursos...</p>
            </div>

            <!-- Contador -->
            <p id="contadorCursosModal" style="margin:0; font-size:.8rem; color:var(--slate-500); text-align:right;">
                0 cursos seleccionados
            </p>
        </div>

        <!-- Pie -->
        <div style="padding:1rem 1.5rem; background:var(--slate-50); border-top:1px solid var(--slate-200); display:flex; gap:.75rem; justify-content:flex-end; flex-shrink:0;">
            <button onclick="cerrarModalRefreshCursos()" style="padding:.55rem 1.25rem; background:#fff; border:1px solid var(--slate-300); border-radius:8px; cursor:pointer; font-size:.875rem; color:var(--slate-700);">
                Cancelar
            </button>
            <button id="btnConfirmarRefreshCursos" onclick="confirmarRefreshCursosElegidos()" disabled
                style="padding:.55rem 1.25rem; background:linear-gradient(135deg,#0f766e,#0891b2); color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:.875rem; font-weight:600; opacity:.5; transition:opacity .2s;">
                <i class="fas fa-sync-alt"></i> Actualizar seleccionados
            </button>
        </div>
    </div>
</div>

<script>
// ── Modal: Actualizar cursos elegidos ─────────────────────────
document.getElementById('modalRefreshCursos').addEventListener('click', (e) => {
    if (e.target.id === 'modalRefreshCursos') cerrarModalRefreshCursos();
});

function abrirModalRefreshCursos() {
    if (!DATA || !DATA.cursos || DATA.cursos.length === 0) {
        showToast('No hay datos de cursos cargados. Recargue la página.', 'error');
        return;
    }
    _cursosModalData = DATA.cursos.map(c => ({
        id: parseInt(c.id_moodle),
        nombre: c.nombre || c['Nombre completo del curso'] || c.id_moodle,
        seleccionado: false,
    })).filter(c => c.id);

    document.getElementById('filtroCursosModal').value = '';
    _renderizarListaCursosModal('');
    document.getElementById('modalRefreshCursos').style.display = 'flex';
}

function cerrarModalRefreshCursos() {
    document.getElementById('modalRefreshCursos').style.display = 'none';
}

let _cursosModalData = [];

function _renderizarListaCursosModal(filtro) {
    const lista = document.getElementById('listaCursosModal');
    const term = filtro.toLowerCase().trim();
    const visibles = _cursosModalData.filter(c =>
        !term || c.nombre.toLowerCase().includes(term)
    );

    if (visibles.length === 0) {
        lista.innerHTML = '<p style="text-align:center; color:var(--slate-400); padding:2rem; margin:0;">Sin resultados</p>';
        return;
    }

    lista.innerHTML = visibles.map(c => `
        <label style="display:flex; align-items:center; gap:.75rem; padding:.65rem 1rem; cursor:pointer; border-bottom:1px solid var(--slate-100); transition:background .15s;"
               onmouseover="this.style.background='#f0fdfa'" onmouseout="this.style.background=''">
            <input type="checkbox" data-cid="${c.id}" ${c.seleccionado ? 'checked' : ''}
                onchange="_toggleCursoModal(${c.id}, this.checked)"
                style="width:16px; height:16px; accent-color:#0f766e; flex-shrink:0; cursor:pointer;">
            <span style="font-size:.875rem; color:var(--slate-700); line-height:1.3;">${_escapeHtml(c.nombre)}</span>
        </label>
    `).join('');

    _actualizarContadorCursosModal();
}

function _escapeHtml(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function _toggleCursoModal(id, checked) {
    const c = _cursosModalData.find(x => x.id === id);
    if (c) c.seleccionado = checked;
    _actualizarContadorCursosModal();
}

function _actualizarContadorCursosModal() {
    const seleccionados = _cursosModalData.filter(c => c.seleccionado).length;
    document.getElementById('contadorCursosModal').textContent =
        seleccionados === 0 ? 'Sin selección' :
        seleccionados === 1 ? '1 curso seleccionado' :
        `${seleccionados} cursos seleccionados`;
    const btn = document.getElementById('btnConfirmarRefreshCursos');
    btn.disabled = seleccionados === 0;
    btn.style.opacity = seleccionados === 0 ? '.5' : '1';
    btn.style.cursor  = seleccionados === 0 ? 'not-allowed' : 'pointer';
}

function filtrarCursosModal() {
    const term = document.getElementById('filtroCursosModal').value;
    _renderizarListaCursosModal(term);
}

function seleccionarTodosCursosModal() {
    const term = document.getElementById('filtroCursosModal').value.toLowerCase().trim();
    _cursosModalData.forEach(c => {
        if (!term || c.nombre.toLowerCase().includes(term)) c.seleccionado = true;
    });
    _renderizarListaCursosModal(document.getElementById('filtroCursosModal').value);
}

function limpiarSeleccionCursosModal() {
    _cursosModalData.forEach(c => c.seleccionado = false);
    _renderizarListaCursosModal(document.getElementById('filtroCursosModal').value);
}

async function confirmarRefreshCursosElegidos() {
    const seleccionados = _cursosModalData.filter(c => c.seleccionado).map(c => c.id);
    if (seleccionados.length === 0) return;

    cerrarModalRefreshCursos();
    await refreshMoodleData(seleccionados);
}
</script>

</body>
</html>
